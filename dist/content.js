(()=>{"use strict";class e{static getDocumentContent(){try{return Array.from(document.querySelectorAll(".kix-paragraphrenderer")).map((e=>e.textContent)).join("\n")}catch(e){return console.error("Error getting document content:",e),""}}static getSelectedText(){try{if(window.getSelection){const e=window.getSelection();if(e)return e.toString()}return""}catch(e){return console.error("Error getting selected text:",e),""}}static addComment(e){try{if(!this.getSelectedText())return console.warn("No text selected to add a comment to"),!1;const t=document.querySelector('[aria-label="Add comment"]');return t&&(t.click(),setTimeout((()=>{var t,n;const o=document.querySelector(".docos-input-textarea");o&&(null===(n=null===(t=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,"value"))||void 0===t?void 0:t.set)||void 0===n||n.call(o,e),o.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout((()=>{const e=Array.from(document.querySelectorAll("button")).find((e=>"Comment"===e.textContent));if(e)return e.click(),!0}),300))}),500)),!1}catch(e){return console.error("Error adding comment:",e),!1}}static isInGoogleDocs(){return window.location.href.startsWith("https://docs.google.com/document/")}static getDocumentTitle(){try{const e=document.querySelector(".docs-title-input");return e&&e.textContent||"Untitled Document"}catch(e){return console.error("Error getting document title:",e),"Untitled Document"}}}function t(){const e=document.getElementById("vibewrite-sidebar");e&&e.classList.toggle("open")}function n(){chrome.runtime.sendMessage({type:"ANALYZE_DOCUMENT"});const e=document.getElementById("vibewrite-sidebar");e&&!e.classList.contains("open")&&e.classList.add("open")}function o(){const t=e.getSelectedText();if(!t)return void alert("Please select some text to give feedback on.");const n=document.getElementById("vibewrite-sidebar");n&&!n.classList.contains("open")&&n.classList.add("open"),chrome.runtime.sendMessage({type:"CHAT_REQUEST",payload:{message:`Please review and improve the following text: "${t}"`,selectedText:t}})}window.vibeWriteInjected?console.log("VibeWrite already injected, skipping..."):(window.vibeWriteInjected=!0,console.log("VibeWrite content script loaded"),window.addEventListener("load",(function(){return r=this,c=void 0,s=function*(){console.log("Initializing VibeWrite..."),e.isInGoogleDocs()?(yield function(e,t=1e4){return new Promise(((n,o)=>{const r=Date.now();!function c(){const i=document.querySelector(e);i?n(i):Date.now()-r>t?o(new Error(`Timeout waiting for element: ${e}`)):setTimeout(c,100)}()}))}(".docs-titlebar-buttons"),function(){try{const e=document.createElement("div");e.className="vibewrite-sidebar-container",e.id="vibewrite-sidebar",document.body.appendChild(e);const r=document.createElement("iframe");r.style.width="100%",r.style.height="100%",r.style.border="none",r.src=chrome.runtime.getURL("sidebar.html"),e.appendChild(r);const c=document.querySelector(".docs-titlebar-buttons");if(c){const e=document.createElement("div");e.className="vibewrite-toolbar",e.style.display="inline-flex",e.style.alignItems="center";const r=document.createElement("button");r.className="vibewrite-button",r.textContent="VibeWrite",r.style.backgroundColor="#1a73e8",r.style.color="white",r.style.padding="8px 12px",r.style.border="none",r.style.borderRadius="4px",r.style.cursor="pointer",r.style.marginRight="10px",r.addEventListener("click",t);const i=document.createElement("button");i.className="vibewrite-button",i.textContent="Analyze",i.addEventListener("click",n);const s=document.createElement("button");s.className="vibewrite-button",s.textContent="Add Feedback",s.addEventListener("click",o),e.appendChild(r),e.appendChild(i),e.appendChild(s),c.insertBefore(e,c.firstChild),console.log("VibeWrite UI added successfully")}}catch(e){console.error("Error adding VibeWrite UI:",e)}}(),chrome.runtime.onMessage.addListener(((n,o,r)=>{var c;switch(console.log("Content script received message:",n),n.type){case"TOGGLE_SIDEBAR":t(),r({success:!0});break;case"RELOAD_SETTINGS":console.log("Reloading settings in content script");const o=document.querySelector("#vibewrite-sidebar iframe");o&&(null===(c=o.contentWindow)||void 0===c||c.postMessage({type:"RELOAD_SETTINGS"},"*")),r({success:!0});break;case"GET_SELECTED_TEXT":r({success:!0,data:e.getSelectedText()});break;case"GET_DOCUMENT_CONTENT":r({success:!0,data:e.getDocumentContent()});break;case"ADD_COMMENT":n.payload&&n.payload.commentText?r({success:e.addComment(n.payload.commentText)}):r({success:!1,error:"No comment text provided"});break;default:r({success:!1,error:"Unknown message type"})}return!0}))):console.log("Not in a Google Docs document, exiting...")},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{a(s.next(e))}catch(e){t(e)}}function o(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var r;t.done?e(t.value):(r=t.value,r instanceof i?r:new i((function(e){e(r)}))).then(n,o)}a((s=s.apply(r,c||[])).next())}));var r,c,i,s})))})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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SCxFQUFjQyx1QkFFdEMsTUFDSixJQUFLLGNBQ0c2RCxFQUFRRCxTQUFXQyxFQUFRRCxRQUFRM0MsWUFFbkM4RixFQUFhLENBQUVDLFFBRENqSCxFQUFjaUIsV0FBVzZDLEVBQVFELFFBQVEzQyxlQUl6RDhGLEVBQWEsQ0FDVEMsU0FBUyxFQUNUdkcsTUFBTyw2QkFHZixNQUNKLFFBQ0lzRyxFQUFhLENBQ1RDLFNBQVMsRUFDVHZHLE1BQU8seUJBR25CLE9BQU8sQ0FBSSxLQXhKUEMsUUFBUXFELElBQUksNENBU3BCLEVBakNPLEtBRmdFcUQsT0FzQnhDLEtBcEJiQSxFQUFJOUMsV0FBVSxTQUFVQyxFQUFTQyxHQUMvQyxTQUFTNkMsRUFBVUMsR0FBUyxJQUFNQyxFQUFLcEQsRUFBVXFELEtBQUtGLEdBQVMsQ0FBRSxNQUFPRyxHQUFLakQsRUFBT2lELEVBQUksQ0FBRSxDQUMxRixTQUFTQyxFQUFTSixHQUFTLElBQU1DLEVBQUtwRCxFQUFpQixNQUFFbUQsR0FBUyxDQUFFLE1BQU9HLEdBQUtqRCxFQUFPaUQsRUFBSSxDQUFFLENBQzdGLFNBQVNGLEVBQUtJLEdBSmxCLElBQWVMLEVBSWFLLEVBQU9DLEtBQU9yRCxFQUFRb0QsRUFBT0wsUUFKMUNBLEVBSXlESyxFQUFPTCxNQUpoREEsYUFBaUJGLEVBQUlFLEVBQVEsSUFBSUYsR0FBRSxTQUFVN0MsR0FBV0EsRUFBUStDLEVBQVEsS0FJakJPLEtBQUtSLEVBQVdLLEVBQVcsQ0FDN0dILEdBQU1wRCxFQUFZQSxFQUFVMkQsTUFBTTdELEVBQVNDLEdBQWMsS0FBS3NELE9BQ2xFLElBUHdDLElBQVV2RCxFQUFTQyxFQUFZa0QsRUFBR2pELENBb0M5RSxJIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vdmliZXdyaXRlLy4vc3JjL3V0aWxzL2dvb2dsZS1kb2NzLWFwaS50cyIsIndlYnBhY2s6Ly92aWJld3JpdGUvLi9zcmMvY29udGVudC9pbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBUEkgZm9yIGludGVyYWN0aW5nIHdpdGggR29vZ2xlIERvY3NcbmV4cG9ydCBjbGFzcyBHb29nbGVEb2NzQVBJIHtcbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZXMgdGhlIGVudGlyZSBkb2N1bWVudCBjb250ZW50IGZyb20gR29vZ2xlIERvY3NcbiAgICAgKi9cbiAgICBzdGF0aWMgZ2V0RG9jdW1lbnRDb250ZW50KCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gR2V0IGFsbCB0ZXh0IGNvbnRlbnQgZnJvbSB0aGUgZG9jdW1lbnRcbiAgICAgICAgICAgIGNvbnN0IGRvY3VtZW50Q29udGVudCA9IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5raXgtcGFyYWdyYXBocmVuZGVyZXJcIikpXG4gICAgICAgICAgICAgICAgLm1hcCgoZWxlbWVudCkgPT4gZWxlbWVudC50ZXh0Q29udGVudClcbiAgICAgICAgICAgICAgICAuam9pbihcIlxcblwiKTtcbiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudENvbnRlbnQ7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgZ2V0dGluZyBkb2N1bWVudCBjb250ZW50OlwiLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gXCJcIjtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvKipcbiAgICAgKiBHZXRzIHRoZSBjdXJyZW50IHNlbGVjdGVkIHRleHQgaW4gR29vZ2xlIERvY3NcbiAgICAgKi9cbiAgICBzdGF0aWMgZ2V0U2VsZWN0ZWRUZXh0KCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gVXNpbmcgdGhlIEdvb2dsZSBEb2NzIHNlbGVjdGlvbiBmdW5jdGlvbmFsaXR5XG4gICAgICAgICAgICBpZiAod2luZG93LmdldFNlbGVjdGlvbikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcbiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxlY3Rpb24udG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBnZXR0aW5nIHNlbGVjdGVkIHRleHQ6XCIsIGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybiBcIlwiO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEFkZCBhIEdvb2dsZSBEb2NzIGNvbW1lbnQgYXQgdGhlIGN1cnJlbnQgc2VsZWN0aW9uXG4gICAgICogQHBhcmFtIGNvbW1lbnRUZXh0IC0gVGV4dCB0byBhZGQgYXMgYSBjb21tZW50XG4gICAgICovXG4gICAgc3RhdGljIGFkZENvbW1lbnQoY29tbWVudFRleHQpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIEZpcnN0LCBuZWVkIHRvIG1ha2Ugc3VyZSBzb21ldGhpbmcgaXMgc2VsZWN0ZWRcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkVGV4dCA9IHRoaXMuZ2V0U2VsZWN0ZWRUZXh0KCk7XG4gICAgICAgICAgICBpZiAoIXNlbGVjdGVkVGV4dCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihcIk5vIHRleHQgc2VsZWN0ZWQgdG8gYWRkIGEgY29tbWVudCB0b1wiKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBTaW11bGF0ZSBjbGlja2luZyB0aGUgXCJBZGQgY29tbWVudFwiIGJ1dHRvbiBvciBtZW51IGl0ZW1cbiAgICAgICAgICAgIGNvbnN0IGNvbW1lbnRCdXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbYXJpYS1sYWJlbD1cIkFkZCBjb21tZW50XCJdJyk7XG4gICAgICAgICAgICBpZiAoY29tbWVudEJ1dHRvbikge1xuICAgICAgICAgICAgICAgIGNvbW1lbnRCdXR0b24uY2xpY2soKTtcbiAgICAgICAgICAgICAgICAvLyBXYWl0IGZvciB0aGUgY29tbWVudCBib3ggdG8gYXBwZWFyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgICAgICAgICAgICAgIC8vIEZpbmQgdGhlIGNvbW1lbnQgaW5wdXQgYm94IGFuZCBpbnNlcnQgb3VyIHRleHRcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tbWVudEJveCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuZG9jb3MtaW5wdXQtdGV4dGFyZWFcIik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjb21tZW50Qm94KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIHZhbHVlIG9mIHRoZSBjb21tZW50IGJveFxuICAgICAgICAgICAgICAgICAgICAgICAgKF9iID0gKF9hID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihIVE1MVGV4dEFyZWFFbGVtZW50LnByb3RvdHlwZSwgXCJ2YWx1ZVwiKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmNhbGwoY29tbWVudEJveCwgY29tbWVudFRleHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBpbnB1dCBldmVudCB0byBlbnN1cmUgR29vZ2xlIERvY3MgcmVjb2duaXplcyB0aGUgY2hhbmdlXG4gICAgICAgICAgICAgICAgICAgICAgICBjb21tZW50Qm94LmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KFwiaW5wdXRcIiwgeyBidWJibGVzOiB0cnVlIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN1Ym1pdCB0aGUgY29tbWVudCAtIGZpbmQgdGhlIFwiQ29tbWVudFwiIGJ1dHRvbiBhbmQgY2xpY2sgaXRcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbW1lbnRTdWJtaXRCdXR0b24gPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJidXR0b25cIikpLmZpbmQoKGJ1dHRvbikgPT4gYnV0dG9uLnRleHRDb250ZW50ID09PSBcIkNvbW1lbnRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1lbnRTdWJtaXRCdXR0b24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tbWVudFN1Ym1pdEJ1dHRvbi5jbGljaygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LCAzMDApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgNTAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBhZGRpbmcgY29tbWVudDpcIiwgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIHdlJ3JlIGluIGEgR29vZ2xlIERvY3MgZG9jdW1lbnRcbiAgICAgKi9cbiAgICBzdGF0aWMgaXNJbkdvb2dsZURvY3MoKSB7XG4gICAgICAgIHJldHVybiB3aW5kb3cubG9jYXRpb24uaHJlZi5zdGFydHNXaXRoKFwiaHR0cHM6Ly9kb2NzLmdvb2dsZS5jb20vZG9jdW1lbnQvXCIpO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGN1cnJlbnQgZG9jdW1lbnQncyB0aXRsZVxuICAgICAqL1xuICAgIHN0YXRpYyBnZXREb2N1bWVudFRpdGxlKCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdGl0bGVFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5kb2NzLXRpdGxlLWlucHV0XCIpO1xuICAgICAgICAgICAgaWYgKHRpdGxlRWxlbWVudCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aXRsZUVsZW1lbnQudGV4dENvbnRlbnQgfHwgXCJVbnRpdGxlZCBEb2N1bWVudFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIFwiVW50aXRsZWQgRG9jdW1lbnRcIjtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBnZXR0aW5nIGRvY3VtZW50IHRpdGxlOlwiLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gXCJVbnRpdGxlZCBEb2N1bWVudFwiO1xuICAgICAgICB9XG4gICAgfVxufVxuIiwiLyoqXG4gKiBDb250ZW50IFNjcmlwdCBmb3IgVmliZVdyaXRlIC0gR29vZ2xlIERvY3MgSW50ZWdyYXRpb25cbiAqXG4gKiBUaGlzIHNjcmlwdCBpcyBpbmplY3RlZCBpbnRvIEdvb2dsZSBEb2NzIHBhZ2VzIGFuZCBoYW5kbGVzOlxuICogLSBBZGRpbmcgVUkgZWxlbWVudHMgdG8gdGhlIEdvb2dsZSBEb2NzIGludGVyZmFjZVxuICogLSBDcmVhdGluZyBhbmQgbWFuYWdpbmcgdGhlIHNpZGViYXJcbiAqIC0gQ29tbXVuaWNhdGluZyB3aXRoIHRoZSBHb29nbGUgRG9jcyBkb2N1bWVudFxuICogLSBTZW5kaW5nIGRvY3VtZW50IGNvbnRlbnQgdG8gdGhlIGJhY2tncm91bmQgc2NyaXB0XG4gKi9cbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuaW1wb3J0IHsgR29vZ2xlRG9jc0FQSSB9IGZyb20gXCIuLi91dGlscy9nb29nbGUtZG9jcy1hcGlcIjtcbi8vIElmIGFscmVhZHkgaW5qZWN0ZWQsIGV4aXQgZWFybHlcbmlmICh3aW5kb3cudmliZVdyaXRlSW5qZWN0ZWQpIHtcbiAgICBjb25zb2xlLmxvZyhcIlZpYmVXcml0ZSBhbHJlYWR5IGluamVjdGVkLCBza2lwcGluZy4uLlwiKTtcbn1cbmVsc2Uge1xuICAgIHdpbmRvdy52aWJlV3JpdGVJbmplY3RlZCA9IHRydWU7XG4gICAgY29uc29sZS5sb2coXCJWaWJlV3JpdGUgY29udGVudCBzY3JpcHQgbG9hZGVkXCIpO1xuICAgIC8vIEluaXRpYWxpemUgVmliZVdyaXRlIGFmdGVyIHRoZSBwYWdlIGhhcyBmdWxseSBsb2FkZWRcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIiwgaW5pdFZpYmVXcml0ZSk7XG59XG4vLyBNYWluIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9uXG5mdW5jdGlvbiBpbml0VmliZVdyaXRlKCkge1xuICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiSW5pdGlhbGl6aW5nIFZpYmVXcml0ZS4uLlwiKTtcbiAgICAgICAgLy8gT25seSBydW4gb24gR29vZ2xlIERvY3MgZG9jdW1lbnQgcGFnZXNcbiAgICAgICAgaWYgKCFHb29nbGVEb2NzQVBJLmlzSW5Hb29nbGVEb2NzKCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTm90IGluIGEgR29vZ2xlIERvY3MgZG9jdW1lbnQsIGV4aXRpbmcuLi5cIik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gV2FpdCBmb3IgdGhlIEdvb2dsZSBEb2NzIFVJIHRvIGZ1bGx5IGxvYWRcbiAgICAgICAgeWllbGQgd2FpdEZvckVsZW1lbnQoXCIuZG9jcy10aXRsZWJhci1idXR0b25zXCIpO1xuICAgICAgICAvLyBBZGQgb3VyIGN1c3RvbSBVSSBlbGVtZW50c1xuICAgICAgICBhZGRWaWJlV3JpdGVVSSgpO1xuICAgICAgICAvLyBTZXQgdXAgbWVzc2FnZSBoYW5kbGluZ1xuICAgICAgICBzZXR1cE1lc3NhZ2VIYW5kbGVycygpO1xuICAgIH0pO1xufVxuLy8gRnVuY3Rpb24gdG8gY3JlYXRlIGFuZCBhZGQgdGhlIFZpYmVXcml0ZSBVSSB0byBHb29nbGUgRG9jc1xuZnVuY3Rpb24gYWRkVmliZVdyaXRlVUkoKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgLy8gQ3JlYXRlIHRoZSBzaWRlYmFyIGNvbnRhaW5lclxuICAgICAgICBjb25zdCBzaWRlYmFyQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgICAgc2lkZWJhckNvbnRhaW5lci5jbGFzc05hbWUgPSBcInZpYmV3cml0ZS1zaWRlYmFyLWNvbnRhaW5lclwiO1xuICAgICAgICBzaWRlYmFyQ29udGFpbmVyLmlkID0gXCJ2aWJld3JpdGUtc2lkZWJhclwiO1xuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNpZGViYXJDb250YWluZXIpO1xuICAgICAgICAvLyBDcmVhdGUgdGhlIHNpZGViYXIgaWZyYW1lXG4gICAgICAgIGNvbnN0IHNpZGViYXJJZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiaWZyYW1lXCIpO1xuICAgICAgICBzaWRlYmFySWZyYW1lLnN0eWxlLndpZHRoID0gXCIxMDAlXCI7XG4gICAgICAgIHNpZGViYXJJZnJhbWUuc3R5bGUuaGVpZ2h0ID0gXCIxMDAlXCI7XG4gICAgICAgIHNpZGViYXJJZnJhbWUuc3R5bGUuYm9yZGVyID0gXCJub25lXCI7XG4gICAgICAgIHNpZGViYXJJZnJhbWUuc3JjID0gY2hyb21lLnJ1bnRpbWUuZ2V0VVJMKFwic2lkZWJhci5odG1sXCIpO1xuICAgICAgICBzaWRlYmFyQ29udGFpbmVyLmFwcGVuZENoaWxkKHNpZGViYXJJZnJhbWUpO1xuICAgICAgICAvLyBBZGQgVmliZVdyaXRlIGJ1dHRvbnMgdG8gdGhlIEdvb2dsZSBEb2NzIHRvb2xiYXJcbiAgICAgICAgY29uc3QgdG9vbGJhckNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuZG9jcy10aXRsZWJhci1idXR0b25zXCIpO1xuICAgICAgICBpZiAodG9vbGJhckNvbnRhaW5lcikge1xuICAgICAgICAgICAgLy8gQ3JlYXRlIGNvbnRhaW5lciBmb3Igb3VyIGJ1dHRvbnNcbiAgICAgICAgICAgIGNvbnN0IHZpYmVXcml0ZVRvb2xiYXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgICAgICAgICAgdmliZVdyaXRlVG9vbGJhci5jbGFzc05hbWUgPSBcInZpYmV3cml0ZS10b29sYmFyXCI7XG4gICAgICAgICAgICB2aWJlV3JpdGVUb29sYmFyLnN0eWxlLmRpc3BsYXkgPSBcImlubGluZS1mbGV4XCI7XG4gICAgICAgICAgICB2aWJlV3JpdGVUb29sYmFyLnN0eWxlLmFsaWduSXRlbXMgPSBcImNlbnRlclwiOyAvLyBDcmVhdGUgdG9nZ2xlIHNpZGViYXIgYnV0dG9uXG4gICAgICAgICAgICBjb25zdCB0b2dnbGVTaWRlYmFyQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJ1dHRvblwiKTtcbiAgICAgICAgICAgIHRvZ2dsZVNpZGViYXJCdXR0b24uY2xhc3NOYW1lID0gXCJ2aWJld3JpdGUtYnV0dG9uXCI7XG4gICAgICAgICAgICB0b2dnbGVTaWRlYmFyQnV0dG9uLnRleHRDb250ZW50ID0gXCJWaWJlV3JpdGVcIjtcbiAgICAgICAgICAgIHRvZ2dsZVNpZGViYXJCdXR0b24uc3R5bGUuYmFja2dyb3VuZENvbG9yID0gXCIjMWE3M2U4XCI7XG4gICAgICAgICAgICB0b2dnbGVTaWRlYmFyQnV0dG9uLnN0eWxlLmNvbG9yID0gXCJ3aGl0ZVwiO1xuICAgICAgICAgICAgdG9nZ2xlU2lkZWJhckJ1dHRvbi5zdHlsZS5wYWRkaW5nID0gXCI4cHggMTJweFwiO1xuICAgICAgICAgICAgdG9nZ2xlU2lkZWJhckJ1dHRvbi5zdHlsZS5ib3JkZXIgPSBcIm5vbmVcIjtcbiAgICAgICAgICAgIHRvZ2dsZVNpZGViYXJCdXR0b24uc3R5bGUuYm9yZGVyUmFkaXVzID0gXCI0cHhcIjtcbiAgICAgICAgICAgIHRvZ2dsZVNpZGViYXJCdXR0b24uc3R5bGUuY3Vyc29yID0gXCJwb2ludGVyXCI7XG4gICAgICAgICAgICB0b2dnbGVTaWRlYmFyQnV0dG9uLnN0eWxlLm1hcmdpblJpZ2h0ID0gXCIxMHB4XCI7XG4gICAgICAgICAgICB0b2dnbGVTaWRlYmFyQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCB0b2dnbGVTaWRlYmFyKTtcbiAgICAgICAgICAgIC8vIENyZWF0ZSBhbmFseXplIGJ1dHRvblxuICAgICAgICAgICAgY29uc3QgYW5hbHl6ZUJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJidXR0b25cIik7XG4gICAgICAgICAgICBhbmFseXplQnV0dG9uLmNsYXNzTmFtZSA9IFwidmliZXdyaXRlLWJ1dHRvblwiO1xuICAgICAgICAgICAgYW5hbHl6ZUJ1dHRvbi50ZXh0Q29udGVudCA9IFwiQW5hbHl6ZVwiO1xuICAgICAgICAgICAgYW5hbHl6ZUJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgYW5hbHl6ZURvY3VtZW50KTtcbiAgICAgICAgICAgIC8vIENyZWF0ZSBmZWVkYmFjayBidXR0b25cbiAgICAgICAgICAgIGNvbnN0IGZlZWRiYWNrQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJ1dHRvblwiKTtcbiAgICAgICAgICAgIGZlZWRiYWNrQnV0dG9uLmNsYXNzTmFtZSA9IFwidmliZXdyaXRlLWJ1dHRvblwiO1xuICAgICAgICAgICAgZmVlZGJhY2tCdXR0b24udGV4dENvbnRlbnQgPSBcIkFkZCBGZWVkYmFja1wiO1xuICAgICAgICAgICAgZmVlZGJhY2tCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGFkZEZlZWRiYWNrKTtcbiAgICAgICAgICAgIC8vIEFkZCBidXR0b25zIHRvIHRoZSB0b29sYmFyXG4gICAgICAgICAgICB2aWJlV3JpdGVUb29sYmFyLmFwcGVuZENoaWxkKHRvZ2dsZVNpZGViYXJCdXR0b24pO1xuICAgICAgICAgICAgdmliZVdyaXRlVG9vbGJhci5hcHBlbmRDaGlsZChhbmFseXplQnV0dG9uKTtcbiAgICAgICAgICAgIHZpYmVXcml0ZVRvb2xiYXIuYXBwZW5kQ2hpbGQoZmVlZGJhY2tCdXR0b24pO1xuICAgICAgICAgICAgLy8gSW5zZXJ0IG91ciB0b29sYmFyIGJlZm9yZSB0aGUgc2hhcmUgYnV0dG9uXG4gICAgICAgICAgICB0b29sYmFyQ29udGFpbmVyLmluc2VydEJlZm9yZSh2aWJlV3JpdGVUb29sYmFyLCB0b29sYmFyQ29udGFpbmVyLmZpcnN0Q2hpbGQpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJWaWJlV3JpdGUgVUkgYWRkZWQgc3VjY2Vzc2Z1bGx5XCIpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgYWRkaW5nIFZpYmVXcml0ZSBVSTpcIiwgZXJyb3IpO1xuICAgIH1cbn1cbi8vIEZ1bmN0aW9uIHRvIHRvZ2dsZSB0aGUgc2lkZWJhclxuZnVuY3Rpb24gdG9nZ2xlU2lkZWJhcigpIHtcbiAgICBjb25zdCBzaWRlYmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ2aWJld3JpdGUtc2lkZWJhclwiKTtcbiAgICBpZiAoc2lkZWJhcikge1xuICAgICAgICBzaWRlYmFyLmNsYXNzTGlzdC50b2dnbGUoXCJvcGVuXCIpO1xuICAgIH1cbn1cbi8vIEZ1bmN0aW9uIHRvIGFuYWx5emUgdGhlIGRvY3VtZW50IGFuZCBzaG93IHN1Z2dlc3Rpb25zXG5mdW5jdGlvbiBhbmFseXplRG9jdW1lbnQoKSB7XG4gICAgLy8gU2VuZCBtZXNzYWdlIHRvIHRoZSBzaWRlYmFyIHRvIGFuYWx5emUgdGhlIGRvY3VtZW50XG4gICAgY2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2UoeyB0eXBlOiBcIkFOQUxZWkVfRE9DVU1FTlRcIiB9KTtcbiAgICAvLyBNYWtlIHN1cmUgdGhlIHNpZGViYXIgaXMgb3BlblxuICAgIGNvbnN0IHNpZGViYXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInZpYmV3cml0ZS1zaWRlYmFyXCIpO1xuICAgIGlmIChzaWRlYmFyICYmICFzaWRlYmFyLmNsYXNzTGlzdC5jb250YWlucyhcIm9wZW5cIikpIHtcbiAgICAgICAgc2lkZWJhci5jbGFzc0xpc3QuYWRkKFwib3BlblwiKTtcbiAgICB9XG59XG4vLyBGdW5jdGlvbiB0byBhZGQgZmVlZGJhY2sgdG8gc2VsZWN0ZWQgdGV4dFxuZnVuY3Rpb24gYWRkRmVlZGJhY2soKSB7XG4gICAgLy8gR2V0IHRoZSBzZWxlY3RlZCB0ZXh0XG4gICAgY29uc3Qgc2VsZWN0ZWRUZXh0ID0gR29vZ2xlRG9jc0FQSS5nZXRTZWxlY3RlZFRleHQoKTtcbiAgICBpZiAoIXNlbGVjdGVkVGV4dCkge1xuICAgICAgICBhbGVydChcIlBsZWFzZSBzZWxlY3Qgc29tZSB0ZXh0IHRvIGdpdmUgZmVlZGJhY2sgb24uXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIE9wZW4gdGhlIHNpZGViYXJcbiAgICBjb25zdCBzaWRlYmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ2aWJld3JpdGUtc2lkZWJhclwiKTtcbiAgICBpZiAoc2lkZWJhciAmJiAhc2lkZWJhci5jbGFzc0xpc3QuY29udGFpbnMoXCJvcGVuXCIpKSB7XG4gICAgICAgIHNpZGViYXIuY2xhc3NMaXN0LmFkZChcIm9wZW5cIik7XG4gICAgfVxuICAgIC8vIFNlbmQgYSBtZXNzYWdlIHRvIHRoZSBzaWRlYmFyIHRvIGFuYWx5emUgdGhlIHNlbGVjdGVkIHRleHRcbiAgICBjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZSh7XG4gICAgICAgIHR5cGU6IFwiQ0hBVF9SRVFVRVNUXCIsXG4gICAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBQbGVhc2UgcmV2aWV3IGFuZCBpbXByb3ZlIHRoZSBmb2xsb3dpbmcgdGV4dDogXCIke3NlbGVjdGVkVGV4dH1cImAsXG4gICAgICAgICAgICBzZWxlY3RlZFRleHQsXG4gICAgICAgIH0sXG4gICAgfSk7XG59XG4vLyBTZXQgdXAgbWVzc2FnZSBoYW5kbGVyc1xuZnVuY3Rpb24gc2V0dXBNZXNzYWdlSGFuZGxlcnMoKSB7XG4gICAgY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmFkZExpc3RlbmVyKChtZXNzYWdlLCBzZW5kZXIsIHNlbmRSZXNwb25zZSkgPT4ge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ29udGVudCBzY3JpcHQgcmVjZWl2ZWQgbWVzc2FnZTpcIiwgbWVzc2FnZSk7XG4gICAgICAgIHN3aXRjaCAobWVzc2FnZS50eXBlKSB7XG4gICAgICAgICAgICBjYXNlIFwiVE9HR0xFX1NJREVCQVJcIjpcbiAgICAgICAgICAgICAgICB0b2dnbGVTaWRlYmFyKCk7XG4gICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKHsgc3VjY2VzczogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJSRUxPQURfU0VUVElOR1NcIjpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlJlbG9hZGluZyBzZXR0aW5ncyBpbiBjb250ZW50IHNjcmlwdFwiKTtcbiAgICAgICAgICAgICAgICAvLyBGb3J3YXJkIHRoZSBtZXNzYWdlIHRvIHRoZSBzaWRlYmFyIGlmcmFtZVxuICAgICAgICAgICAgICAgIGNvbnN0IHNpZGViYXJJZnJhbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3ZpYmV3cml0ZS1zaWRlYmFyIGlmcmFtZVwiKTtcbiAgICAgICAgICAgICAgICBpZiAoc2lkZWJhcklmcmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAoX2EgPSBzaWRlYmFySWZyYW1lLmNvbnRlbnRXaW5kb3cpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wb3N0TWVzc2FnZSh7IHR5cGU6IFwiUkVMT0FEX1NFVFRJTkdTXCIgfSwgXCIqXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UoeyBzdWNjZXNzOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcIkdFVF9TRUxFQ1RFRF9URVhUXCI6XG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRUZXh0ID0gR29vZ2xlRG9jc0FQSS5nZXRTZWxlY3RlZFRleHQoKTtcbiAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UoeyBzdWNjZXNzOiB0cnVlLCBkYXRhOiBzZWxlY3RlZFRleHQgfSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiR0VUX0RPQ1VNRU5UX0NPTlRFTlRcIjpcbiAgICAgICAgICAgICAgICBjb25zdCBkb2N1bWVudENvbnRlbnQgPSBHb29nbGVEb2NzQVBJLmdldERvY3VtZW50Q29udGVudCgpO1xuICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IGRvY3VtZW50Q29udGVudCB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJBRERfQ09NTUVOVFwiOlxuICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLnBheWxvYWQgJiYgbWVzc2FnZS5wYXlsb2FkLmNvbW1lbnRUZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBHb29nbGVEb2NzQVBJLmFkZENvbW1lbnQobWVzc2FnZS5wYXlsb2FkLmNvbW1lbnRUZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKHsgc3VjY2VzcyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBcIk5vIGNvbW1lbnQgdGV4dCBwcm92aWRlZFwiLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogXCJVbmtub3duIG1lc3NhZ2UgdHlwZVwiLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlOyAvLyBJbmRpY2F0ZXMgd2UnbGwgcmVzcG9uZCBhc3luY2hyb25vdXNseVxuICAgIH0pO1xufVxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIHdhaXQgZm9yIGFuIGVsZW1lbnQgdG8gYmUgcHJlc2VudCBpbiB0aGUgRE9NXG5mdW5jdGlvbiB3YWl0Rm9yRWxlbWVudChzZWxlY3RvciwgdGltZW91dCA9IDEwMDAwKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgZnVuY3Rpb24gY2hlY2tFbGVtZW50KCkge1xuICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xuICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKGVsZW1lbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSA+IHRpbWVvdXQpIHtcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBUaW1lb3V0IHdhaXRpbmcgZm9yIGVsZW1lbnQ6ICR7c2VsZWN0b3J9YCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChjaGVja0VsZW1lbnQsIDEwMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2hlY2tFbGVtZW50KCk7XG4gICAgfSk7XG59XG4iXSwibmFtZXMiOlsiR29vZ2xlRG9jc0FQSSIsImdldERvY3VtZW50Q29udGVudCIsIkFycmF5IiwiZnJvbSIsImRvY3VtZW50IiwicXVlcnlTZWxlY3RvckFsbCIsIm1hcCIsImVsZW1lbnQiLCJ0ZXh0Q29udGVudCIsImpvaW4iLCJlcnJvciIsImNvbnNvbGUiLCJnZXRTZWxlY3RlZFRleHQiLCJ3aW5kb3ciLCJnZXRTZWxlY3Rpb24iLCJzZWxlY3Rpb24iLCJ0b1N0cmluZyIsImFkZENvbW1lbnQiLCJjb21tZW50VGV4dCIsInRoaXMiLCJ3YXJuIiwiY29tbWVudEJ1dHRvbiIsInF1ZXJ5U2VsZWN0b3IiLCJjbGljayIsInNldFRpbWVvdXQiLCJfYSIsIl9iIiwiY29tbWVudEJveCIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsIkhUTUxUZXh0QXJlYUVsZW1lbnQiLCJwcm90b3R5cGUiLCJzZXQiLCJjYWxsIiwiZGlzcGF0Y2hFdmVudCIsIkV2ZW50IiwiYnViYmxlcyIsImNvbW1lbnRTdWJtaXRCdXR0b24iLCJmaW5kIiwiYnV0dG9uIiwiaXNJbkdvb2dsZURvY3MiLCJsb2NhdGlvbiIsImhyZWYiLCJzdGFydHNXaXRoIiwiZ2V0RG9jdW1lbnRUaXRsZSIsInRpdGxlRWxlbWVudCIsInRvZ2dsZVNpZGViYXIiLCJzaWRlYmFyIiwiZ2V0RWxlbWVudEJ5SWQiLCJjbGFzc0xpc3QiLCJ0b2dnbGUiLCJhbmFseXplRG9jdW1lbnQiLCJjaHJvbWUiLCJydW50aW1lIiwic2VuZE1lc3NhZ2UiLCJ0eXBlIiwiY29udGFpbnMiLCJhZGQiLCJhZGRGZWVkYmFjayIsInNlbGVjdGVkVGV4dCIsImFsZXJ0IiwicGF5bG9hZCIsIm1lc3NhZ2UiLCJ2aWJlV3JpdGVJbmplY3RlZCIsImxvZyIsImFkZEV2ZW50TGlzdGVuZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsImdlbmVyYXRvciIsInNlbGVjdG9yIiwidGltZW91dCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwic3RhcnRUaW1lIiwiRGF0ZSIsIm5vdyIsImNoZWNrRWxlbWVudCIsIkVycm9yIiwid2FpdEZvckVsZW1lbnQiLCJzaWRlYmFyQ29udGFpbmVyIiwiY3JlYXRlRWxlbWVudCIsImNsYXNzTmFtZSIsImlkIiwiYm9keSIsImFwcGVuZENoaWxkIiwic2lkZWJhcklmcmFtZSIsInN0eWxlIiwid2lkdGgiLCJoZWlnaHQiLCJib3JkZXIiLCJzcmMiLCJnZXRVUkwiLCJ0b29sYmFyQ29udGFpbmVyIiwidmliZVdyaXRlVG9vbGJhciIsImRpc3BsYXkiLCJhbGlnbkl0ZW1zIiwidG9nZ2xlU2lkZWJhckJ1dHRvbiIsImJhY2tncm91bmRDb2xvciIsImNvbG9yIiwicGFkZGluZyIsImJvcmRlclJhZGl1cyIsImN1cnNvciIsIm1hcmdpblJpZ2h0IiwiYW5hbHl6ZUJ1dHRvbiIsImZlZWRiYWNrQnV0dG9uIiwiaW5zZXJ0QmVmb3JlIiwiZmlyc3RDaGlsZCIsImFkZFZpYmVXcml0ZVVJIiwib25NZXNzYWdlIiwiYWRkTGlzdGVuZXIiLCJzZW5kZXIiLCJzZW5kUmVzcG9uc2UiLCJzdWNjZXNzIiwiY29udGVudFdpbmRvdyIsInBvc3RNZXNzYWdlIiwiZGF0YSIsIlAiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSJdLCJzb3VyY2VSb290IjoiIn0=