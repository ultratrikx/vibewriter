(()=>{"use strict";class e{static startDebugLogging(){null===this.debugInterval&&(console.log("Starting GoogleDocsAPI debug logging"),this.debugInterval=window.setInterval((()=>{var e;const t=Date.now();if(t-this.lastDebugTime>5e3){this.lastDebugTime=t;const o=this.isInGoogleDocs(),n=document.querySelectorAll(".kix-paragraphrenderer");if(console.log(`[GoogleDocsAPI Debug] isInGoogleDocs: ${o}`),console.log(`[GoogleDocsAPI Debug] paragraphs found: ${(null==n?void 0:n.length)||0}`),n&&n.length>0){const t=null===(e=n[0].textContent)||void 0===e?void 0:e.substring(0,50);console.log(`[GoogleDocsAPI Debug] First paragraph starts with: ${t}...`)}}}),1e3))}static stopDebugLogging(){null!==this.debugInterval&&(window.clearInterval(this.debugInterval),this.debugInterval=null,console.log("Stopped GoogleDocsAPI debug logging"))}static isInGoogleDocs(){try{return"docs.google.com"===window.location.hostname&&(null!==document.querySelector(".kix-paragraphrenderer")||null!==document.querySelector(".docs-editor"))}catch(e){return console.error("Error checking if in Google Docs:",e),!1}}static getDocumentContent(e=3){try{if(console.log("Attempting to retrieve document content..."),!this.isInGoogleDocs())return console.error("Not in a Google Docs document"),"";const t=document.querySelectorAll(".kix-paragraphrenderer");if(!t||0===t.length){if(console.error("Could not find paragraph elements in document, DOM might not be ready"),this.startDebugLogging(),e>0){console.log(`Trying alternative selectors (${e} retries left)`);const t=[".kix-page-content-wrapper",".docs-texteventtarget-iframe",".docs-editor-container"];for(const e of t){const t=document.querySelectorAll(e);if(t&&t.length>0){console.log(`Found ${t.length} elements with selector ${e}`);const o=Array.from(t).map((e=>e.textContent)).filter(Boolean).join("\n");if(o)return console.log(`Retrieved ${o.length} characters using alternative selector`),o}}return new Promise((t=>{setTimeout((()=>{t(this.getDocumentContent(e-1))}),500)}))}return""}const o=Array.from(t).map((e=>e.textContent)).join("\n");return o?this.stopDebugLogging():(console.warn("Document content appears to be empty"),this.startDebugLogging()),console.log(`Retrieved ${o.length} characters from document`),o}catch(e){return console.error("Error getting document content:",e),this.startDebugLogging(),""}}static getSelectedText(){try{if(window.getSelection){const e=window.getSelection();if(e)return e.toString()}return""}catch(e){return console.error("Error getting selected text:",e),""}}static addComment(e){try{if(!this.getSelectedText())return console.warn("No text selected to add a comment to"),!1;const t=document.querySelector('[aria-label="Add comment"]');return t&&(t.click(),setTimeout((()=>{var t,o;const n=document.querySelector(".docos-input-textarea");n&&(null===(o=null===(t=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,"value"))||void 0===t?void 0:t.set)||void 0===o||o.call(n,e),n.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout((()=>{const e=Array.from(document.querySelectorAll("button")).find((e=>"Comment"===e.textContent));if(e)return e.click(),!0}),300))}),500)),!1}catch(e){return console.error("Error adding comment:",e),!1}}static isGoogleDocsUrl(e){return e.startsWith("https://docs.google.com/document/")}static getDocumentTitle(){try{const e=document.querySelector(".docs-title-input");return e&&e.textContent||"Untitled Document"}catch(e){return console.error("Error getting document title:",e),"Untitled Document"}}}e.debugInterval=null,e.lastDebugTime=0;function t(){const e=document.getElementById("vibewrite-sidebar");e&&e.classList.toggle("open")}function o(){var e;const t=document.getElementById("vibewrite-sidebar");t&&!t.classList.contains("open")&&t.classList.add("open");const o=document.querySelector("#vibewrite-sidebar iframe");o?(console.log("Sending ANALYZE_DOCUMENT to sidebar iframe"),null===(e=o.contentWindow)||void 0===e||e.postMessage({type:"ANALYZE_DOCUMENT"},"*")):(console.error("Could not find sidebar iframe"),chrome.runtime.sendMessage({type:"ANALYZE_DOCUMENT"}))}function n(){const t=e.getSelectedText();if(!t)return void alert("Please select some text to give feedback on.");const o=document.getElementById("vibewrite-sidebar");o&&!o.classList.contains("open")&&o.classList.add("open"),chrome.runtime.sendMessage({type:"CHAT_REQUEST",payload:{message:`Please review and improve the following text: "${t}"`,selectedText:t}})}window.vibeWriteInjected?console.log("VibeWrite already injected, skipping..."):(window.vibeWriteInjected=!0,console.log("VibeWrite content script loaded"),window.addEventListener("load",(function(){return r=this,c=void 0,i=function*(){console.log("Initializing VibeWrite..."),e.isInGoogleDocs()?(yield function(e,t=1e4){return new Promise(((o,n)=>{const r=Date.now();!function c(){const s=document.querySelector(e);s?o(s):Date.now()-r>t?n(new Error(`Timeout waiting for element: ${e}`)):setTimeout(c,100)}()}))}(".docs-titlebar-buttons"),function(){console.log("Starting document content monitoring..."),e.startDebugLogging();let t=0;const o=setInterval((()=>{t++;try{const n=e.getDocumentContent();n?(console.log(`Document content monitoring: Content accessible (${n.length} chars)`),clearInterval(o),e.stopDebugLogging()):console.warn(`Document content monitoring: No content available (check ${t}/20)`)}catch(e){console.error("Document content monitoring: Error accessing content",e)}t>=20&&(console.warn("Document content monitoring: Max checks reached, stopping monitoring"),clearInterval(o))}),3e3)}(),function(){try{const e=document.createElement("div");e.className="vibewrite-sidebar-container",e.id="vibewrite-sidebar",document.body.appendChild(e);const r=document.createElement("iframe");r.style.width="100%",r.style.height="100%",r.style.border="none",r.src=chrome.runtime.getURL("sidebar.html"),e.appendChild(r);const c=document.querySelector(".docs-titlebar-buttons");if(c){const e=document.createElement("div");e.className="vibewrite-toolbar",e.style.display="inline-flex",e.style.alignItems="center";const r=document.createElement("button");r.className="vibewrite-button",r.textContent="VibeWrite",r.style.backgroundColor="#1a73e8",r.style.color="white",r.style.padding="8px 12px",r.style.border="none",r.style.borderRadius="4px",r.style.cursor="pointer",r.style.marginRight="10px",r.addEventListener("click",t);const s=document.createElement("button");s.className="vibewrite-button",s.textContent="Analyze",s.addEventListener("click",o);const i=document.createElement("button");i.className="vibewrite-button",i.textContent="Add Feedback",i.addEventListener("click",n),e.appendChild(r),e.appendChild(s),e.appendChild(i),c.insertBefore(e,c.firstChild),console.log("VibeWrite UI added successfully")}}catch(e){console.error("Error adding VibeWrite UI:",e)}}(),chrome.runtime.onMessage.addListener(((o,n,r)=>{var c;switch(console.log("Content script received message:",o),o.type){case"TOGGLE_SIDEBAR":t(),r({success:!0});break;case"RELOAD_SETTINGS":console.log("Reloading settings in content script");const n=document.querySelector("#vibewrite-sidebar iframe");n&&(null===(c=n.contentWindow)||void 0===c||c.postMessage({type:"RELOAD_SETTINGS"},"*")),r({success:!0});break;case"GET_SELECTED_TEXT":r({success:!0,data:e.getSelectedText()});break;case"GET_DOCUMENT_CONTENT":r({success:!0,data:e.getDocumentContent()});break;case"ADD_COMMENT":o.payload&&o.payload.commentText?r({success:e.addComment(o.payload.commentText)}):r({success:!1,error:"No comment text provided"});break;default:r({success:!1,error:"Unknown message type"})}return!0}))):console.log("Not in a Google Docs document, exiting...")},new((s=void 0)||(s=Promise))((function(e,t){function o(e){try{l(i.next(e))}catch(e){t(e)}}function n(e){try{l(i.throw(e))}catch(e){t(e)}}function l(t){var r;t.done?e(t.value):(r=t.value,r instanceof s?r:new s((function(e){e(r)}))).then(o,n)}l((i=i.apply(r,c||[])).next())}));var r,c,s,i})))})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC5qcyIsIm1hcHBpbmdzIjoibUJBQ08sTUFBTUEsRUFJVCx3QkFBT0MsR0FFd0IsT0FBdkJDLEtBQUtDLGdCQUVUQyxRQUFRQyxJQUFJLHdDQUNaSCxLQUFLQyxjQUFnQkcsT0FBT0MsYUFBWSxLQUNwQyxJQUFJQyxFQUNKLE1BQU1DLEVBQU1DLEtBQUtELE1BRWpCLEdBQUlBLEVBQU1QLEtBQUtTLGNBQWdCLElBQU0sQ0FDakNULEtBQUtTLGNBQWdCRixFQUNyQixNQUFNRyxFQUFXVixLQUFLVyxpQkFDaEJDLEVBQWFDLFNBQVNDLGlCQUFpQiwwQkFHN0MsR0FGQVosUUFBUUMsSUFBSSx5Q0FBeUNPLEtBQ3JEUixRQUFRQyxJQUFJLDRDQUE0Q1MsYUFBK0MsRUFBU0EsRUFBV0csU0FBVyxLQUNsSUgsR0FBY0EsRUFBV0csT0FBUyxFQUFHLENBQ3JDLE1BQU1DLEVBQWlELFFBQXBDVixFQUFLTSxFQUFXLEdBQUdLLG1CQUFnQyxJQUFQWCxPQUFnQixFQUFTQSxFQUFHWSxVQUFVLEVBQUcsSUFDeEdoQixRQUFRQyxJQUFJLHNEQUFzRGEsT0FDdEUsQ0FDSixJQUNELEtBQ1AsQ0FJQSx1QkFBT0csR0FDd0IsT0FBdkJuQixLQUFLQyxnQkFDTEcsT0FBT2dCLGNBQWNwQixLQUFLQyxlQUMxQkQsS0FBS0MsY0FBZ0IsS0FDckJDLFFBQVFDLElBQUksdUNBRXBCLENBSUEscUJBQU9RLEdBQ0gsSUFLSSxNQUg4QyxvQkFBN0JQLE9BQU9pQixTQUFTQyxXQUN5QixPQUFyRFQsU0FBU1UsY0FBYywyQkFDdUIsT0FBM0NWLFNBQVNVLGNBQWMsZ0JBRW5DLENBQ0EsTUFBT0MsR0FFSCxPQURBdEIsUUFBUXNCLE1BQU0sb0NBQXFDQSxJQUM1QyxDQUNYLENBQ0osQ0FHQSx5QkFBT0MsQ0FBbUJDLEVBQWEsR0FDbkMsSUFHSSxHQUZBeEIsUUFBUUMsSUFBSSwrQ0FFUEgsS0FBS1csaUJBRU4sT0FEQVQsUUFBUXNCLE1BQU0saUNBQ1AsR0FHWCxNQUFNWixFQUFhQyxTQUFTQyxpQkFBaUIsMEJBQzdDLElBQUtGLEdBQW9DLElBQXRCQSxFQUFXRyxPQUFjLENBS3hDLEdBSkFiLFFBQVFzQixNQUFNLHlFQUVkeEIsS0FBS0Qsb0JBRUQyQixFQUFhLEVBQUcsQ0FDaEJ4QixRQUFRQyxJQUFJLGlDQUFpQ3VCLG1CQUU3QyxNQUFNQyxFQUFlLENBQ2pCLDRCQUNBLCtCQUNBLDBCQUVKLElBQUssTUFBTUMsS0FBWUQsRUFBYyxDQUNqQyxNQUFNRSxFQUFXaEIsU0FBU0MsaUJBQWlCYyxHQUMzQyxHQUFJQyxHQUFZQSxFQUFTZCxPQUFTLEVBQUcsQ0FDakNiLFFBQVFDLElBQUksU0FBUzBCLEVBQVNkLGlDQUFpQ2EsS0FFL0QsTUFBTUUsRUFBVUMsTUFBTUMsS0FBS0gsR0FDdEJJLEtBQUtDLEdBQVlBLEVBQVFqQixjQUN6QmtCLE9BQU9DLFNBQ1BDLEtBQUssTUFDVixHQUFJUCxFQUVBLE9BREE1QixRQUFRQyxJQUFJLGFBQWEyQixFQUFRZixnREFDMUJlLENBRWYsQ0FDSixDQUVBLE9BQU8sSUFBSVEsU0FBU0MsSUFDaEJDLFlBQVcsS0FDUEQsRUFBUXZDLEtBQUt5QixtQkFBbUJDLEVBQWEsR0FBRyxHQUNqRCxJQUFJLEdBRWYsQ0FDQSxNQUFPLEVBQ1gsQ0FFQSxNQUFNZSxFQUFrQlYsTUFBTUMsS0FBS3BCLEdBQzlCcUIsS0FBS0MsR0FBWUEsRUFBUWpCLGNBQ3pCb0IsS0FBSyxNQVVWLE9BVEtJLEVBTUR6QyxLQUFLbUIsb0JBTExqQixRQUFRd0MsS0FBSyx3Q0FDYjFDLEtBQUtELHFCQU1URyxRQUFRQyxJQUFJLGFBQWFzQyxFQUFnQjFCLG1DQUNsQzBCLENBQ1gsQ0FDQSxNQUFPakIsR0FHSCxPQUZBdEIsUUFBUXNCLE1BQU0sa0NBQW1DQSxHQUNqRHhCLEtBQUtELG9CQUNFLEVBQ1gsQ0FDSixDQUlBLHNCQUFPNEMsR0FDSCxJQUVJLEdBQUl2QyxPQUFPd0MsYUFBYyxDQUNyQixNQUFNQyxFQUFZekMsT0FBT3dDLGVBQ3pCLEdBQUlDLEVBQ0EsT0FBT0EsRUFBVUMsVUFFekIsQ0FDQSxNQUFPLEVBQ1gsQ0FDQSxNQUFPdEIsR0FFSCxPQURBdEIsUUFBUXNCLE1BQU0sK0JBQWdDQSxHQUN2QyxFQUNYLENBQ0osQ0FLQSxpQkFBT3VCLENBQVdDLEdBQ2QsSUFHSSxJQURxQmhELEtBQUsyQyxrQkFHdEIsT0FEQXpDLFFBQVF3QyxLQUFLLHlDQUNOLEVBR1gsTUFBTU8sRUFBZ0JwQyxTQUFTVSxjQUFjLDhCQXdCN0MsT0F2QkkwQixJQUNBQSxFQUFjQyxRQUVkVixZQUFXLEtBQ1AsSUFBSWxDLEVBQUk2QyxFQUVSLE1BQU1DLEVBQWF2QyxTQUFTVSxjQUFjLHlCQUN0QzZCLElBRXNJLFFBQXJJRCxFQUF3RixRQUFsRjdDLEVBQUsrQyxPQUFPQyx5QkFBeUJDLG9CQUFvQkMsVUFBVyxnQkFBNkIsSUFBUGxELE9BQWdCLEVBQVNBLEVBQUdtRCxXQUF3QixJQUFQTixHQUF5QkEsRUFBR08sS0FBS04sRUFBWUosR0FFM0xJLEVBQVdPLGNBQWMsSUFBSUMsTUFBTSxRQUFTLENBQUVDLFNBQVMsS0FFdkRyQixZQUFXLEtBQ1AsTUFBTXNCLEVBQXNCL0IsTUFBTUMsS0FBS25CLFNBQVNDLGlCQUFpQixXQUFXaUQsTUFBTUMsR0FBa0MsWUFBdkJBLEVBQU8vQyxjQUNwRyxHQUFJNkMsRUFFQSxPQURBQSxFQUFvQlosU0FDYixDQUNYLEdBQ0QsS0FDUCxHQUNELE9BRUEsQ0FDWCxDQUNBLE1BQU8xQixHQUVILE9BREF0QixRQUFRc0IsTUFBTSx3QkFBeUJBLElBQ2hDLENBQ1gsQ0FDSixDQUlBLHNCQUFPeUMsQ0FBZ0JDLEdBQ25CLE9BQU9BLEVBQUlDLFdBQVcsb0NBQzFCLENBSUEsdUJBQU9DLEdBQ0gsSUFDSSxNQUFNQyxFQUFleEQsU0FBU1UsY0FBYyxxQkFDNUMsT0FBSThDLEdBQ09BLEVBQWFwRCxhQUVqQixtQkFDWCxDQUNBLE1BQU9PLEdBRUgsT0FEQXRCLFFBQVFzQixNQUFNLGdDQUFpQ0EsR0FDeEMsbUJBQ1gsQ0FDSixFQUVKMUIsRUFBY0csY0FBZ0IsS0FDOUJILEVBQWNXLGNBQWdCLEVDekU5QixTQUFTNkQsSUFDTCxNQUFNQyxFQUFVMUQsU0FBUzJELGVBQWUscUJBQ3BDRCxHQUNBQSxFQUFRRSxVQUFVQyxPQUFPLE9BRWpDLENBRUEsU0FBU0MsSUFDTCxJQUFJckUsRUFFSixNQUFNaUUsRUFBVTFELFNBQVMyRCxlQUFlLHFCQUNwQ0QsSUFBWUEsRUFBUUUsVUFBVUcsU0FBUyxTQUN2Q0wsRUFBUUUsVUFBVUksSUFBSSxRQUcxQixNQUFNQyxFQUFnQmpFLFNBQVNVLGNBQWMsNkJBQ3pDdUQsR0FDQTVFLFFBQVFDLElBQUksOENBQzJCLFFBQXRDRyxFQUFLd0UsRUFBY0MscUJBQWtDLElBQVB6RSxHQUF5QkEsRUFBRzBFLFlBQVksQ0FBRUMsS0FBTSxvQkFBc0IsT0FHckgvRSxRQUFRc0IsTUFBTSxpQ0FFZDBELE9BQU9DLFFBQVFDLFlBQVksQ0FBRUgsS0FBTSxxQkFFM0MsQ0FFQSxTQUFTSSxJQUVMLE1BQU1DLEVBQWV4RixFQUFjNkMsa0JBQ25DLElBQUsyQyxFQUVELFlBREFDLE1BQU0sZ0RBSVYsTUFBTWhCLEVBQVUxRCxTQUFTMkQsZUFBZSxxQkFDcENELElBQVlBLEVBQVFFLFVBQVVHLFNBQVMsU0FDdkNMLEVBQVFFLFVBQVVJLElBQUksUUFHMUJLLE9BQU9DLFFBQVFDLFlBQVksQ0FDdkJILEtBQU0sZUFDTk8sUUFBUyxDQUNMQyxRQUFTLGtEQUFrREgsS0FDM0RBLGlCQUdaLENBcEtJbEYsT0FBT3NGLGtCQUNQeEYsUUFBUUMsSUFBSSw0Q0FHWkMsT0FBT3NGLG1CQUFvQixFQUMzQnhGLFFBQVFDLElBQUksbUNBRVpDLE9BQU91RixpQkFBaUIsUUFHNUIsV0FDSSxPQXRCa0RDLEVBc0JqQzVGLEtBdEIwQzZGLE9Bc0JwQyxFQXRCbURDLEVBc0JuQyxZQUNuQzVGLFFBQVFDLElBQUksNkJBRVBMLEVBQWNhLHdCQXdNM0IsU0FBd0JpQixFQUFVbUUsRUFBVSxLQUN4QyxPQUFPLElBQUl6RCxTQUFRLENBQUNDLEVBQVN5RCxLQUN6QixNQUFNQyxFQUFZekYsS0FBS0QsT0FDdkIsU0FBUzJGLElBQ0wsTUFBTWhFLEVBQVVyQixTQUFTVSxjQUFjSyxHQUNuQ00sRUFDQUssRUFBUUwsR0FFSDFCLEtBQUtELE1BQVEwRixFQUFZRixFQUM5QkMsRUFBTyxJQUFJRyxNQUFNLGdDQUFnQ3ZFLE1BR2pEWSxXQUFXMEQsRUFBYyxJQUVqQyxDQUNBQSxFQUFjLEdBRXRCLENBcE5jRSxDQUFlLDBCQVU3QixXQUNJbEcsUUFBUUMsSUFBSSwyQ0FFWkwsRUFBY0Msb0JBRWQsSUFBSXNHLEVBQWEsRUFDakIsTUFDTUMsRUFBZ0JqRyxhQUFZLEtBQzlCZ0csSUFDQSxJQUNJLE1BQU12RSxFQUFVaEMsRUFBYzJCLHFCQUMxQkssR0FDQTVCLFFBQVFDLElBQUksb0RBQW9EMkIsRUFBUWYsaUJBQ3hFSyxjQUFja0YsR0FDZHhHLEVBQWNxQixvQkFHZGpCLFFBQVF3QyxLQUFLLDREQUE0RDJELFFBRWpGLENBQ0EsTUFBT0UsR0FDSHJHLFFBQVFzQixNQUFNLHVEQUF3RCtFLEVBQzFFLENBRUlGLEdBbEJVLEtBbUJWbkcsUUFBUXdDLEtBQUssd0VBQ2J0QixjQUFja0YsR0FDbEIsR0FDRCxJQUNQLENBckNRRSxHQXVDUixXQUNJLElBRUksTUFBTUMsRUFBbUI1RixTQUFTNkYsY0FBYyxPQUNoREQsRUFBaUJFLFVBQVksOEJBQzdCRixFQUFpQkcsR0FBSyxvQkFDdEIvRixTQUFTZ0csS0FBS0MsWUFBWUwsR0FFMUIsTUFBTTNCLEVBQWdCakUsU0FBUzZGLGNBQWMsVUFDN0M1QixFQUFjaUMsTUFBTUMsTUFBUSxPQUM1QmxDLEVBQWNpQyxNQUFNRSxPQUFTLE9BQzdCbkMsRUFBY2lDLE1BQU1HLE9BQVMsT0FDN0JwQyxFQUFjcUMsSUFBTWpDLE9BQU9DLFFBQVFpQyxPQUFPLGdCQUMxQ1gsRUFBaUJLLFlBQVloQyxHQUU3QixNQUFNdUMsRUFBbUJ4RyxTQUFTVSxjQUFjLDBCQUNoRCxHQUFJOEYsRUFBa0IsQ0FFbEIsTUFBTUMsRUFBbUJ6RyxTQUFTNkYsY0FBYyxPQUNoRFksRUFBaUJYLFVBQVksb0JBQzdCVyxFQUFpQlAsTUFBTVEsUUFBVSxjQUNqQ0QsRUFBaUJQLE1BQU1TLFdBQWEsU0FDcEMsTUFBTUMsRUFBc0I1RyxTQUFTNkYsY0FBYyxVQUNuRGUsRUFBb0JkLFVBQVksbUJBQ2hDYyxFQUFvQnhHLFlBQWMsWUFDbEN3RyxFQUFvQlYsTUFBTVcsZ0JBQWtCLFVBQzVDRCxFQUFvQlYsTUFBTVksTUFBUSxRQUNsQ0YsRUFBb0JWLE1BQU1hLFFBQVUsV0FDcENILEVBQW9CVixNQUFNRyxPQUFTLE9BQ25DTyxFQUFvQlYsTUFBTWMsYUFBZSxNQUN6Q0osRUFBb0JWLE1BQU1lLE9BQVMsVUFDbkNMLEVBQW9CVixNQUFNZ0IsWUFBYyxPQUN4Q04sRUFBb0I5QixpQkFBaUIsUUFBU3JCLEdBRTlDLE1BQU0wRCxFQUFnQm5ILFNBQVM2RixjQUFjLFVBQzdDc0IsRUFBY3JCLFVBQVksbUJBQzFCcUIsRUFBYy9HLFlBQWMsVUFDNUIrRyxFQUFjckMsaUJBQWlCLFFBQVNoQixHQUV4QyxNQUFNc0QsRUFBaUJwSCxTQUFTNkYsY0FBYyxVQUM5Q3VCLEVBQWV0QixVQUFZLG1CQUMzQnNCLEVBQWVoSCxZQUFjLGVBQzdCZ0gsRUFBZXRDLGlCQUFpQixRQUFTTixHQUV6Q2lDLEVBQWlCUixZQUFZVyxHQUM3QkgsRUFBaUJSLFlBQVlrQixHQUM3QlYsRUFBaUJSLFlBQVltQixHQUU3QlosRUFBaUJhLGFBQWFaLEVBQWtCRCxFQUFpQmMsWUFDakVqSSxRQUFRQyxJQUFJLGtDQUNoQixDQUNKLENBQ0EsTUFBT3FCLEdBQ0h0QixRQUFRc0IsTUFBTSw2QkFBOEJBLEVBQ2hELENBQ0osQ0E1RlE0RyxHQWdKSmxELE9BQU9DLFFBQVFrRCxVQUFVQyxhQUFZLENBQUM3QyxFQUFTOEMsRUFBUUMsS0FDbkQsSUFBSWxJLEVBRUosT0FEQUosUUFBUUMsSUFBSSxtQ0FBb0NzRixHQUN4Q0EsRUFBUVIsTUFDWixJQUFLLGlCQUNEWCxJQUNBa0UsRUFBYSxDQUFFQyxTQUFTLElBQ3hCLE1BQ0osSUFBSyxrQkFDRHZJLFFBQVFDLElBQUksd0NBRVosTUFBTTJFLEVBQWdCakUsU0FBU1UsY0FBYyw2QkFDekN1RCxJQUN1QyxRQUF0Q3hFLEVBQUt3RSxFQUFjQyxxQkFBa0MsSUFBUHpFLEdBQXlCQSxFQUFHMEUsWUFBWSxDQUFFQyxLQUFNLG1CQUFxQixNQUV4SHVELEVBQWEsQ0FBRUMsU0FBUyxJQUN4QixNQUNKLElBQUssb0JBRURELEVBQWEsQ0FBRUMsU0FBUyxFQUFNQyxLQURUNUksRUFBYzZDLG9CQUVuQyxNQUNKLElBQUssdUJBRUQ2RixFQUFhLENBQUVDLFNBQVMsRUFBTUMsS0FETjVJLEVBQWMyQix1QkFFdEMsTUFDSixJQUFLLGNBQ0dnRSxFQUFRRCxTQUFXQyxFQUFRRCxRQUFReEMsWUFFbkN3RixFQUFhLENBQUVDLFFBREMzSSxFQUFjaUQsV0FBVzBDLEVBQVFELFFBQVF4QyxlQUl6RHdGLEVBQWEsQ0FDVEMsU0FBUyxFQUNUakgsTUFBTyw2QkFHZixNQUNKLFFBQ0lnSCxFQUFhLENBQ1RDLFNBQVMsRUFDVGpILE1BQU8seUJBR25CLE9BQU8sQ0FBSSxLQW5NUHRCLFFBQVFDLElBQUksNENBV3BCLEVBbkNPLEtBRmdFd0ksT0FzQnhDLEtBcEJiQSxFQUFJckcsV0FBVSxTQUFVQyxFQUFTeUQsR0FDL0MsU0FBUzRDLEVBQVVDLEdBQVMsSUFBTUMsRUFBS2hELEVBQVVpRCxLQUFLRixHQUFTLENBQUUsTUFBT0csR0FBS2hELEVBQU9nRCxFQUFJLENBQUUsQ0FDMUYsU0FBU0MsRUFBU0osR0FBUyxJQUFNQyxFQUFLaEQsRUFBaUIsTUFBRStDLEdBQVMsQ0FBRSxNQUFPRyxHQUFLaEQsRUFBT2dELEVBQUksQ0FBRSxDQUM3RixTQUFTRixFQUFLSSxHQUpsQixJQUFlTCxFQUlhSyxFQUFPQyxLQUFPNUcsRUFBUTJHLEVBQU9MLFFBSjFDQSxFQUl5REssRUFBT0wsTUFKaERBLGFBQWlCRixFQUFJRSxFQUFRLElBQUlGLEdBQUUsU0FBVXBHLEdBQVdBLEVBQVFzRyxFQUFRLEtBSWpCTyxLQUFLUixFQUFXSyxFQUFXLENBQzdHSCxHQUFNaEQsRUFBWUEsRUFBVXVELE1BQU16RCxFQUFTQyxHQUFjLEtBQUtrRCxPQUNsRSxJQVB3QyxJQUFVbkQsRUFBU0MsRUFBWThDLEVBQUc3QyxDQXNDOUUsSSIsInNvdXJjZXMiOlsid2VicGFjazovL3ZpYmV3cml0ZS8uL3NyYy91dGlscy9nb29nbGUtZG9jcy1hcGkudHMiLCJ3ZWJwYWNrOi8vdmliZXdyaXRlLy4vc3JjL2NvbnRlbnQvaW5kZXgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQVBJIGZvciBpbnRlcmFjdGluZyB3aXRoIEdvb2dsZSBEb2NzXG5leHBvcnQgY2xhc3MgR29vZ2xlRG9jc0FQSSB7XG4gICAgLyoqXG4gICAgICogU3RhcnQgcGVyaW9kaWMgbG9nZ2luZyBvZiBkb2N1bWVudCBzdGF0ZVxuICAgICAqL1xuICAgIHN0YXRpYyBzdGFydERlYnVnTG9nZ2luZygpIHtcbiAgICAgICAgLy8gRG9uJ3Qgc3RhcnQgbXVsdGlwbGUgZGVidWcgaW50ZXJ2YWxzXG4gICAgICAgIGlmICh0aGlzLmRlYnVnSW50ZXJ2YWwgIT09IG51bGwpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIGNvbnNvbGUubG9nKFwiU3RhcnRpbmcgR29vZ2xlRG9jc0FQSSBkZWJ1ZyBsb2dnaW5nXCIpO1xuICAgICAgICB0aGlzLmRlYnVnSW50ZXJ2YWwgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgIC8vIE9ubHkgbG9nIGV2ZXJ5IDUgc2Vjb25kcyBhdCBtb3N0IHRvIGF2b2lkIHNwYW1taW5nIHRoZSBjb25zb2xlXG4gICAgICAgICAgICBpZiAobm93IC0gdGhpcy5sYXN0RGVidWdUaW1lID4gNTAwMCkge1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdERlYnVnVGltZSA9IG5vdztcbiAgICAgICAgICAgICAgICBjb25zdCBpc0luRG9jcyA9IHRoaXMuaXNJbkdvb2dsZURvY3MoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJhZ3JhcGhzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5raXgtcGFyYWdyYXBocmVuZGVyZXJcIik7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtHb29nbGVEb2NzQVBJIERlYnVnXSBpc0luR29vZ2xlRG9jczogJHtpc0luRG9jc31gKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW0dvb2dsZURvY3NBUEkgRGVidWddIHBhcmFncmFwaHMgZm91bmQ6ICR7KHBhcmFncmFwaHMgPT09IG51bGwgfHwgcGFyYWdyYXBocyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcGFyYWdyYXBocy5sZW5ndGgpIHx8IDB9YCk7XG4gICAgICAgICAgICAgICAgaWYgKHBhcmFncmFwaHMgJiYgcGFyYWdyYXBocy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpcnN0UGFyYSA9IChfYSA9IHBhcmFncmFwaHNbMF0udGV4dENvbnRlbnQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zdWJzdHJpbmcoMCwgNTApO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW0dvb2dsZURvY3NBUEkgRGVidWddIEZpcnN0IHBhcmFncmFwaCBzdGFydHMgd2l0aDogJHtmaXJzdFBhcmF9Li4uYCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LCAxMDAwKTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogU3RvcCBwZXJpb2RpYyBsb2dnaW5nXG4gICAgICovXG4gICAgc3RhdGljIHN0b3BEZWJ1Z0xvZ2dpbmcoKSB7XG4gICAgICAgIGlmICh0aGlzLmRlYnVnSW50ZXJ2YWwgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKHRoaXMuZGVidWdJbnRlcnZhbCk7XG4gICAgICAgICAgICB0aGlzLmRlYnVnSW50ZXJ2YWwgPSBudWxsO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJTdG9wcGVkIEdvb2dsZURvY3NBUEkgZGVidWcgbG9nZ2luZ1wiKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiB3ZSdyZSBjdXJyZW50bHkgaW4gYSBHb29nbGUgRG9jcyBkb2N1bWVudCBlZGl0b3JcbiAgICAgKi9cbiAgICBzdGF0aWMgaXNJbkdvb2dsZURvY3MoKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBDaGVjayBmb3IgR29vZ2xlIERvY3Mgc3BlY2lmaWMgZWxlbWVudHNcbiAgICAgICAgICAgIGNvbnN0IGlzSW5Eb2NzID0gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lID09PSAnZG9jcy5nb29nbGUuY29tJyAmJlxuICAgICAgICAgICAgICAgIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcua2l4LXBhcmFncmFwaHJlbmRlcmVyJykgIT09IG51bGwgfHxcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRvY3MtZWRpdG9yJykgIT09IG51bGwpO1xuICAgICAgICAgICAgcmV0dXJuIGlzSW5Eb2NzO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGNoZWNraW5nIGlmIGluIEdvb2dsZSBEb2NzOlwiLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9IC8qKlxuICAgICAqIFJldHJpZXZlcyB0aGUgZW50aXJlIGRvY3VtZW50IGNvbnRlbnQgZnJvbSBHb29nbGUgRG9jc1xuICAgICAqL1xuICAgIHN0YXRpYyBnZXREb2N1bWVudENvbnRlbnQobWF4UmV0cmllcyA9IDMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQXR0ZW1wdGluZyB0byByZXRyaWV2ZSBkb2N1bWVudCBjb250ZW50Li4uXCIpO1xuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UncmUgaW4gYSBHb29nbGUgRG9jcyBkb2N1bWVudCBlZGl0b3JcbiAgICAgICAgICAgIGlmICghdGhpcy5pc0luR29vZ2xlRG9jcygpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIk5vdCBpbiBhIEdvb2dsZSBEb2NzIGRvY3VtZW50XCIpO1xuICAgICAgICAgICAgICAgIHJldHVybiBcIlwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gR2V0IGFsbCB0ZXh0IGNvbnRlbnQgZnJvbSB0aGUgZG9jdW1lbnRcbiAgICAgICAgICAgIGNvbnN0IHBhcmFncmFwaHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLmtpeC1wYXJhZ3JhcGhyZW5kZXJlclwiKTtcbiAgICAgICAgICAgIGlmICghcGFyYWdyYXBocyB8fCBwYXJhZ3JhcGhzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJDb3VsZCBub3QgZmluZCBwYXJhZ3JhcGggZWxlbWVudHMgaW4gZG9jdW1lbnQsIERPTSBtaWdodCBub3QgYmUgcmVhZHlcIik7XG4gICAgICAgICAgICAgICAgLy8gU3RhcnQgZGVidWcgbG9nZ2luZyB3aGVuIHdlIGNhbid0IGZpbmQgcGFyYWdyYXBoIGVsZW1lbnRzXG4gICAgICAgICAgICAgICAgdGhpcy5zdGFydERlYnVnTG9nZ2luZygpO1xuICAgICAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgcmV0cmllcyBsZWZ0LCB0cnkgYSBkaWZmZXJlbnQgc2VsZWN0b3JcbiAgICAgICAgICAgICAgICBpZiAobWF4UmV0cmllcyA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFRyeWluZyBhbHRlcm5hdGl2ZSBzZWxlY3RvcnMgKCR7bWF4UmV0cmllc30gcmV0cmllcyBsZWZ0KWApO1xuICAgICAgICAgICAgICAgICAgICAvLyBUcnkgYWx0ZXJuYXRpdmUgc2VsZWN0b3JzIGZvciBHb29nbGUgRG9jcyBjb250ZW50XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFsdGVybmF0aXZlcyA9IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiLmtpeC1wYWdlLWNvbnRlbnQtd3JhcHBlclwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCIuZG9jcy10ZXh0ZXZlbnR0YXJnZXQtaWZyYW1lXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcIi5kb2NzLWVkaXRvci1jb250YWluZXJcIlxuICAgICAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHNlbGVjdG9yIG9mIGFsdGVybmF0aXZlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50cyAmJiBlbGVtZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYEZvdW5kICR7ZWxlbWVudHMubGVuZ3RofSBlbGVtZW50cyB3aXRoIHNlbGVjdG9yICR7c2VsZWN0b3J9YCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVHJ5IHRvIGdldCB0aGUgY29udGVudCBmcm9tIHRoZXNlIGVsZW1lbnRzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGVudCA9IEFycmF5LmZyb20oZWxlbWVudHMpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKGVsZW1lbnQpID0+IGVsZW1lbnQudGV4dENvbnRlbnQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoQm9vbGVhbilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmpvaW4oXCJcXG5cIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFJldHJpZXZlZCAke2NvbnRlbnQubGVuZ3RofSBjaGFyYWN0ZXJzIHVzaW5nIGFsdGVybmF0aXZlIHNlbGVjdG9yYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZW50O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyBJZiBub25lIG9mIHRoZSBhbHRlcm5hdGl2ZXMgd29ya2VkLCB3YWl0IGEgYml0IGFuZCByZXRyeSB3aXRoIG9yaWdpbmFsIHNlbGVjdG9yXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLmdldERvY3VtZW50Q29udGVudChtYXhSZXRyaWVzIC0gMSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSwgNTAwKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBcIlwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gRXh0cmFjdCBjb250ZW50XG4gICAgICAgICAgICBjb25zdCBkb2N1bWVudENvbnRlbnQgPSBBcnJheS5mcm9tKHBhcmFncmFwaHMpXG4gICAgICAgICAgICAgICAgLm1hcCgoZWxlbWVudCkgPT4gZWxlbWVudC50ZXh0Q29udGVudClcbiAgICAgICAgICAgICAgICAuam9pbihcIlxcblwiKTtcbiAgICAgICAgICAgIGlmICghZG9jdW1lbnRDb250ZW50KSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKFwiRG9jdW1lbnQgY29udGVudCBhcHBlYXJzIHRvIGJlIGVtcHR5XCIpO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnREZWJ1Z0xvZ2dpbmcoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIENvbnRlbnQgcmV0cmlldmVkIHN1Y2Nlc3NmdWxseSwgd2UgY2FuIHN0b3AgZGVidWcgbG9nZ2luZ1xuICAgICAgICAgICAgICAgIHRoaXMuc3RvcERlYnVnTG9nZ2luZygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc29sZS5sb2coYFJldHJpZXZlZCAke2RvY3VtZW50Q29udGVudC5sZW5ndGh9IGNoYXJhY3RlcnMgZnJvbSBkb2N1bWVudGApO1xuICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50Q29udGVudDtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBnZXR0aW5nIGRvY3VtZW50IGNvbnRlbnQ6XCIsIGVycm9yKTtcbiAgICAgICAgICAgIHRoaXMuc3RhcnREZWJ1Z0xvZ2dpbmcoKTtcbiAgICAgICAgICAgIHJldHVybiBcIlwiO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIGN1cnJlbnQgc2VsZWN0ZWQgdGV4dCBpbiBHb29nbGUgRG9jc1xuICAgICAqL1xuICAgIHN0YXRpYyBnZXRTZWxlY3RlZFRleHQoKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBVc2luZyB0aGUgR29vZ2xlIERvY3Mgc2VsZWN0aW9uIGZ1bmN0aW9uYWxpdHlcbiAgICAgICAgICAgIGlmICh3aW5kb3cuZ2V0U2VsZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0aW9uID0gd2luZG93LmdldFNlbGVjdGlvbigpO1xuICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGVjdGlvbi50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBcIlwiO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGdldHRpbmcgc2VsZWN0ZWQgdGV4dDpcIiwgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogQWRkIGEgR29vZ2xlIERvY3MgY29tbWVudCBhdCB0aGUgY3VycmVudCBzZWxlY3Rpb25cbiAgICAgKiBAcGFyYW0gY29tbWVudFRleHQgLSBUZXh0IHRvIGFkZCBhcyBhIGNvbW1lbnRcbiAgICAgKi9cbiAgICBzdGF0aWMgYWRkQ29tbWVudChjb21tZW50VGV4dCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gRmlyc3QsIG5lZWQgdG8gbWFrZSBzdXJlIHNvbWV0aGluZyBpcyBzZWxlY3RlZFxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRUZXh0ID0gdGhpcy5nZXRTZWxlY3RlZFRleHQoKTtcbiAgICAgICAgICAgIGlmICghc2VsZWN0ZWRUZXh0KSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKFwiTm8gdGV4dCBzZWxlY3RlZCB0byBhZGQgYSBjb21tZW50IHRvXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIFNpbXVsYXRlIGNsaWNraW5nIHRoZSBcIkFkZCBjb21tZW50XCIgYnV0dG9uIG9yIG1lbnUgaXRlbVxuICAgICAgICAgICAgY29uc3QgY29tbWVudEJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1thcmlhLWxhYmVsPVwiQWRkIGNvbW1lbnRcIl0nKTtcbiAgICAgICAgICAgIGlmIChjb21tZW50QnV0dG9uKSB7XG4gICAgICAgICAgICAgICAgY29tbWVudEJ1dHRvbi5jbGljaygpO1xuICAgICAgICAgICAgICAgIC8vIFdhaXQgZm9yIHRoZSBjb21tZW50IGJveCB0byBhcHBlYXJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgICAgICAgICAgICAgLy8gRmluZCB0aGUgY29tbWVudCBpbnB1dCBib3ggYW5kIGluc2VydCBvdXIgdGV4dFxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21tZW50Qm94ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5kb2Nvcy1pbnB1dC10ZXh0YXJlYVwiKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1lbnRCb3gpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgdmFsdWUgb2YgdGhlIGNvbW1lbnQgYm94XG4gICAgICAgICAgICAgICAgICAgICAgICAoX2IgPSAoX2EgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKEhUTUxUZXh0QXJlYUVsZW1lbnQucHJvdG90eXBlLCBcInZhbHVlXCIpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0KSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuY2FsbChjb21tZW50Qm94LCBjb21tZW50VGV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmlnZ2VyIGlucHV0IGV2ZW50IHRvIGVuc3VyZSBHb29nbGUgRG9jcyByZWNvZ25pemVzIHRoZSBjaGFuZ2VcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1lbnRCb3guZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoXCJpbnB1dFwiLCB7IGJ1YmJsZXM6IHRydWUgfSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3VibWl0IHRoZSBjb21tZW50IC0gZmluZCB0aGUgXCJDb21tZW50XCIgYnV0dG9uIGFuZCBjbGljayBpdFxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tbWVudFN1Ym1pdEJ1dHRvbiA9IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImJ1dHRvblwiKSkuZmluZCgoYnV0dG9uKSA9PiBidXR0b24udGV4dENvbnRlbnQgPT09IFwiQ29tbWVudFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWVudFN1Ym1pdEJ1dHRvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21tZW50U3VibWl0QnV0dG9uLmNsaWNrKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDMwMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LCA1MDApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGFkZGluZyBjb21tZW50OlwiLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgYSBVUkwgaXMgYSBHb29nbGUgRG9jcyBkb2N1bWVudCBVUkxcbiAgICAgKi9cbiAgICBzdGF0aWMgaXNHb29nbGVEb2NzVXJsKHVybCkge1xuICAgICAgICByZXR1cm4gdXJsLnN0YXJ0c1dpdGgoXCJodHRwczovL2RvY3MuZ29vZ2xlLmNvbS9kb2N1bWVudC9cIik7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgY3VycmVudCBkb2N1bWVudCdzIHRpdGxlXG4gICAgICovXG4gICAgc3RhdGljIGdldERvY3VtZW50VGl0bGUoKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB0aXRsZUVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmRvY3MtdGl0bGUtaW5wdXRcIik7XG4gICAgICAgICAgICBpZiAodGl0bGVFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRpdGxlRWxlbWVudC50ZXh0Q29udGVudCB8fCBcIlVudGl0bGVkIERvY3VtZW50XCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gXCJVbnRpdGxlZCBEb2N1bWVudFwiO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGdldHRpbmcgZG9jdW1lbnQgdGl0bGU6XCIsIGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybiBcIlVudGl0bGVkIERvY3VtZW50XCI7XG4gICAgICAgIH1cbiAgICB9XG59XG5Hb29nbGVEb2NzQVBJLmRlYnVnSW50ZXJ2YWwgPSBudWxsO1xuR29vZ2xlRG9jc0FQSS5sYXN0RGVidWdUaW1lID0gMDtcbiIsIi8qKlxuICogQ29udGVudCBTY3JpcHQgZm9yIFZpYmVXcml0ZSAtIEdvb2dsZSBEb2NzIEludGVncmF0aW9uXG4gKlxuICogVGhpcyBzY3JpcHQgaXMgaW5qZWN0ZWQgaW50byBHb29nbGUgRG9jcyBwYWdlcyBhbmQgaGFuZGxlczpcbiAqIC0gQWRkaW5nIFVJIGVsZW1lbnRzIHRvIHRoZSBHb29nbGUgRG9jcyBpbnRlcmZhY2VcbiAqIC0gQ3JlYXRpbmcgYW5kIG1hbmFnaW5nIHRoZSBzaWRlYmFyXG4gKiAtIENvbW11bmljYXRpbmcgd2l0aCB0aGUgR29vZ2xlIERvY3MgZG9jdW1lbnRcbiAqIC0gU2VuZGluZyBkb2N1bWVudCBjb250ZW50IHRvIHRoZSBiYWNrZ3JvdW5kIHNjcmlwdFxuICovXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH1cbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbmltcG9ydCB7IEdvb2dsZURvY3NBUEkgfSBmcm9tIFwiLi4vdXRpbHMvZ29vZ2xlLWRvY3MtYXBpXCI7XG4vLyBJZiBhbHJlYWR5IGluamVjdGVkLCBleGl0IGVhcmx5XG5pZiAod2luZG93LnZpYmVXcml0ZUluamVjdGVkKSB7XG4gICAgY29uc29sZS5sb2coXCJWaWJlV3JpdGUgYWxyZWFkeSBpbmplY3RlZCwgc2tpcHBpbmcuLi5cIik7XG59XG5lbHNlIHtcbiAgICB3aW5kb3cudmliZVdyaXRlSW5qZWN0ZWQgPSB0cnVlO1xuICAgIGNvbnNvbGUubG9nKFwiVmliZVdyaXRlIGNvbnRlbnQgc2NyaXB0IGxvYWRlZFwiKTtcbiAgICAvLyBJbml0aWFsaXplIFZpYmVXcml0ZSBhZnRlciB0aGUgcGFnZSBoYXMgZnVsbHkgbG9hZGVkXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJsb2FkXCIsIGluaXRWaWJlV3JpdGUpO1xufVxuLy8gTWFpbiBpbml0aWFsaXphdGlvbiBmdW5jdGlvblxuZnVuY3Rpb24gaW5pdFZpYmVXcml0ZSgpIHtcbiAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIkluaXRpYWxpemluZyBWaWJlV3JpdGUuLi5cIik7XG4gICAgICAgIC8vIE9ubHkgcnVuIG9uIEdvb2dsZSBEb2NzIGRvY3VtZW50IHBhZ2VzXG4gICAgICAgIGlmICghR29vZ2xlRG9jc0FQSS5pc0luR29vZ2xlRG9jcygpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIk5vdCBpbiBhIEdvb2dsZSBEb2NzIGRvY3VtZW50LCBleGl0aW5nLi4uXCIpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8vIFdhaXQgZm9yIHRoZSBHb29nbGUgRG9jcyBVSSB0byBmdWxseSBsb2FkXG4gICAgICAgIHlpZWxkIHdhaXRGb3JFbGVtZW50KFwiLmRvY3MtdGl0bGViYXItYnV0dG9uc1wiKTtcbiAgICAgICAgLy8gU3RhcnQgcGVyaW9kaWMgZG9jdW1lbnQgY29udGVudCBtb25pdG9yaW5nIGZvciBkZWJ1Z2dpbmdcbiAgICAgICAgc3RhcnREb2N1bWVudE1vbml0b3JpbmcoKTtcbiAgICAgICAgLy8gQWRkIG91ciBjdXN0b20gVUkgZWxlbWVudHNcbiAgICAgICAgYWRkVmliZVdyaXRlVUkoKTtcbiAgICAgICAgLy8gU2V0IHVwIG1lc3NhZ2UgaGFuZGxpbmdcbiAgICAgICAgc2V0dXBNZXNzYWdlSGFuZGxlcnMoKTtcbiAgICB9KTtcbn1cbi8vIE1vbml0b3IgZG9jdW1lbnQgY29udGVudCBhdmFpbGFiaWxpdHlcbmZ1bmN0aW9uIHN0YXJ0RG9jdW1lbnRNb25pdG9yaW5nKCkge1xuICAgIGNvbnNvbGUubG9nKFwiU3RhcnRpbmcgZG9jdW1lbnQgY29udGVudCBtb25pdG9yaW5nLi4uXCIpO1xuICAgIC8vIEVuYWJsZSBkZWJ1ZyBsb2dnaW5nIGluIEdvb2dsZURvY3NBUElcbiAgICBHb29nbGVEb2NzQVBJLnN0YXJ0RGVidWdMb2dnaW5nKCk7XG4gICAgLy8gQWxzbyBwZXJmb3JtIG91ciBvd24gY2hlY2sgdG8gZW5zdXJlIGRvY3VtZW50IGlzIGFjY2Vzc2libGVcbiAgICBsZXQgY2hlY2tDb3VudCA9IDA7XG4gICAgY29uc3QgbWF4Q2hlY2tzID0gMjA7XG4gICAgY29uc3QgY2hlY2tJbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgY2hlY2tDb3VudCsrO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IEdvb2dsZURvY3NBUEkuZ2V0RG9jdW1lbnRDb250ZW50KCk7XG4gICAgICAgICAgICBpZiAoY29udGVudCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBEb2N1bWVudCBjb250ZW50IG1vbml0b3Jpbmc6IENvbnRlbnQgYWNjZXNzaWJsZSAoJHtjb250ZW50Lmxlbmd0aH0gY2hhcnMpYCk7XG4gICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChjaGVja0ludGVydmFsKTtcbiAgICAgICAgICAgICAgICBHb29nbGVEb2NzQVBJLnN0b3BEZWJ1Z0xvZ2dpbmcoKTsgLy8gU3RvcCBsb2dnaW5nIG9uY2Ugd2UgY29uZmlybSBpdCB3b3Jrc1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBEb2N1bWVudCBjb250ZW50IG1vbml0b3Jpbmc6IE5vIGNvbnRlbnQgYXZhaWxhYmxlIChjaGVjayAke2NoZWNrQ291bnR9LyR7bWF4Q2hlY2tzfSlgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRG9jdW1lbnQgY29udGVudCBtb25pdG9yaW5nOiBFcnJvciBhY2Nlc3NpbmcgY29udGVudFwiLCBlcnIpO1xuICAgICAgICB9XG4gICAgICAgIC8vIFN0b3AgY2hlY2tpbmcgYWZ0ZXIgbWF4Q2hlY2tzXG4gICAgICAgIGlmIChjaGVja0NvdW50ID49IG1heENoZWNrcykge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKFwiRG9jdW1lbnQgY29udGVudCBtb25pdG9yaW5nOiBNYXggY2hlY2tzIHJlYWNoZWQsIHN0b3BwaW5nIG1vbml0b3JpbmdcIik7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKGNoZWNrSW50ZXJ2YWwpO1xuICAgICAgICB9XG4gICAgfSwgMzAwMCk7XG59XG4vLyBGdW5jdGlvbiB0byBjcmVhdGUgYW5kIGFkZCB0aGUgVmliZVdyaXRlIFVJIHRvIEdvb2dsZSBEb2NzXG5mdW5jdGlvbiBhZGRWaWJlV3JpdGVVSSgpIHtcbiAgICB0cnkge1xuICAgICAgICAvLyBDcmVhdGUgdGhlIHNpZGViYXIgY29udGFpbmVyXG4gICAgICAgIGNvbnN0IHNpZGViYXJDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgICAgICBzaWRlYmFyQ29udGFpbmVyLmNsYXNzTmFtZSA9IFwidmliZXdyaXRlLXNpZGViYXItY29udGFpbmVyXCI7XG4gICAgICAgIHNpZGViYXJDb250YWluZXIuaWQgPSBcInZpYmV3cml0ZS1zaWRlYmFyXCI7XG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2lkZWJhckNvbnRhaW5lcik7XG4gICAgICAgIC8vIENyZWF0ZSB0aGUgc2lkZWJhciBpZnJhbWVcbiAgICAgICAgY29uc3Qgc2lkZWJhcklmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJpZnJhbWVcIik7XG4gICAgICAgIHNpZGViYXJJZnJhbWUuc3R5bGUud2lkdGggPSBcIjEwMCVcIjtcbiAgICAgICAgc2lkZWJhcklmcmFtZS5zdHlsZS5oZWlnaHQgPSBcIjEwMCVcIjtcbiAgICAgICAgc2lkZWJhcklmcmFtZS5zdHlsZS5ib3JkZXIgPSBcIm5vbmVcIjtcbiAgICAgICAgc2lkZWJhcklmcmFtZS5zcmMgPSBjaHJvbWUucnVudGltZS5nZXRVUkwoXCJzaWRlYmFyLmh0bWxcIik7XG4gICAgICAgIHNpZGViYXJDb250YWluZXIuYXBwZW5kQ2hpbGQoc2lkZWJhcklmcmFtZSk7XG4gICAgICAgIC8vIEFkZCBWaWJlV3JpdGUgYnV0dG9ucyB0byB0aGUgR29vZ2xlIERvY3MgdG9vbGJhclxuICAgICAgICBjb25zdCB0b29sYmFyQ29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5kb2NzLXRpdGxlYmFyLWJ1dHRvbnNcIik7XG4gICAgICAgIGlmICh0b29sYmFyQ29udGFpbmVyKSB7XG4gICAgICAgICAgICAvLyBDcmVhdGUgY29udGFpbmVyIGZvciBvdXIgYnV0dG9uc1xuICAgICAgICAgICAgY29uc3QgdmliZVdyaXRlVG9vbGJhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgICAgICB2aWJlV3JpdGVUb29sYmFyLmNsYXNzTmFtZSA9IFwidmliZXdyaXRlLXRvb2xiYXJcIjtcbiAgICAgICAgICAgIHZpYmVXcml0ZVRvb2xiYXIuc3R5bGUuZGlzcGxheSA9IFwiaW5saW5lLWZsZXhcIjtcbiAgICAgICAgICAgIHZpYmVXcml0ZVRvb2xiYXIuc3R5bGUuYWxpZ25JdGVtcyA9IFwiY2VudGVyXCI7IC8vIENyZWF0ZSB0b2dnbGUgc2lkZWJhciBidXR0b25cbiAgICAgICAgICAgIGNvbnN0IHRvZ2dsZVNpZGViYXJCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYnV0dG9uXCIpO1xuICAgICAgICAgICAgdG9nZ2xlU2lkZWJhckJ1dHRvbi5jbGFzc05hbWUgPSBcInZpYmV3cml0ZS1idXR0b25cIjtcbiAgICAgICAgICAgIHRvZ2dsZVNpZGViYXJCdXR0b24udGV4dENvbnRlbnQgPSBcIlZpYmVXcml0ZVwiO1xuICAgICAgICAgICAgdG9nZ2xlU2lkZWJhckJ1dHRvbi5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBcIiMxYTczZThcIjtcbiAgICAgICAgICAgIHRvZ2dsZVNpZGViYXJCdXR0b24uc3R5bGUuY29sb3IgPSBcIndoaXRlXCI7XG4gICAgICAgICAgICB0b2dnbGVTaWRlYmFyQnV0dG9uLnN0eWxlLnBhZGRpbmcgPSBcIjhweCAxMnB4XCI7XG4gICAgICAgICAgICB0b2dnbGVTaWRlYmFyQnV0dG9uLnN0eWxlLmJvcmRlciA9IFwibm9uZVwiO1xuICAgICAgICAgICAgdG9nZ2xlU2lkZWJhckJ1dHRvbi5zdHlsZS5ib3JkZXJSYWRpdXMgPSBcIjRweFwiO1xuICAgICAgICAgICAgdG9nZ2xlU2lkZWJhckJ1dHRvbi5zdHlsZS5jdXJzb3IgPSBcInBvaW50ZXJcIjtcbiAgICAgICAgICAgIHRvZ2dsZVNpZGViYXJCdXR0b24uc3R5bGUubWFyZ2luUmlnaHQgPSBcIjEwcHhcIjtcbiAgICAgICAgICAgIHRvZ2dsZVNpZGViYXJCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHRvZ2dsZVNpZGViYXIpO1xuICAgICAgICAgICAgLy8gQ3JlYXRlIGFuYWx5emUgYnV0dG9uXG4gICAgICAgICAgICBjb25zdCBhbmFseXplQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJ1dHRvblwiKTtcbiAgICAgICAgICAgIGFuYWx5emVCdXR0b24uY2xhc3NOYW1lID0gXCJ2aWJld3JpdGUtYnV0dG9uXCI7XG4gICAgICAgICAgICBhbmFseXplQnV0dG9uLnRleHRDb250ZW50ID0gXCJBbmFseXplXCI7XG4gICAgICAgICAgICBhbmFseXplQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBhbmFseXplRG9jdW1lbnQpO1xuICAgICAgICAgICAgLy8gQ3JlYXRlIGZlZWRiYWNrIGJ1dHRvblxuICAgICAgICAgICAgY29uc3QgZmVlZGJhY2tCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYnV0dG9uXCIpO1xuICAgICAgICAgICAgZmVlZGJhY2tCdXR0b24uY2xhc3NOYW1lID0gXCJ2aWJld3JpdGUtYnV0dG9uXCI7XG4gICAgICAgICAgICBmZWVkYmFja0J1dHRvbi50ZXh0Q29udGVudCA9IFwiQWRkIEZlZWRiYWNrXCI7XG4gICAgICAgICAgICBmZWVkYmFja0J1dHRvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgYWRkRmVlZGJhY2spO1xuICAgICAgICAgICAgLy8gQWRkIGJ1dHRvbnMgdG8gdGhlIHRvb2xiYXJcbiAgICAgICAgICAgIHZpYmVXcml0ZVRvb2xiYXIuYXBwZW5kQ2hpbGQodG9nZ2xlU2lkZWJhckJ1dHRvbik7XG4gICAgICAgICAgICB2aWJlV3JpdGVUb29sYmFyLmFwcGVuZENoaWxkKGFuYWx5emVCdXR0b24pO1xuICAgICAgICAgICAgdmliZVdyaXRlVG9vbGJhci5hcHBlbmRDaGlsZChmZWVkYmFja0J1dHRvbik7XG4gICAgICAgICAgICAvLyBJbnNlcnQgb3VyIHRvb2xiYXIgYmVmb3JlIHRoZSBzaGFyZSBidXR0b25cbiAgICAgICAgICAgIHRvb2xiYXJDb250YWluZXIuaW5zZXJ0QmVmb3JlKHZpYmVXcml0ZVRvb2xiYXIsIHRvb2xiYXJDb250YWluZXIuZmlyc3RDaGlsZCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlZpYmVXcml0ZSBVSSBhZGRlZCBzdWNjZXNzZnVsbHlcIik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBhZGRpbmcgVmliZVdyaXRlIFVJOlwiLCBlcnJvcik7XG4gICAgfVxufVxuLy8gRnVuY3Rpb24gdG8gdG9nZ2xlIHRoZSBzaWRlYmFyXG5mdW5jdGlvbiB0b2dnbGVTaWRlYmFyKCkge1xuICAgIGNvbnN0IHNpZGViYXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInZpYmV3cml0ZS1zaWRlYmFyXCIpO1xuICAgIGlmIChzaWRlYmFyKSB7XG4gICAgICAgIHNpZGViYXIuY2xhc3NMaXN0LnRvZ2dsZShcIm9wZW5cIik7XG4gICAgfVxufVxuLy8gRnVuY3Rpb24gdG8gYW5hbHl6ZSB0aGUgZG9jdW1lbnQgYW5kIHNob3cgc3VnZ2VzdGlvbnNcbmZ1bmN0aW9uIGFuYWx5emVEb2N1bWVudCgpIHtcbiAgICB2YXIgX2E7XG4gICAgLy8gTWFrZSBzdXJlIHRoZSBzaWRlYmFyIGlzIG9wZW5cbiAgICBjb25zdCBzaWRlYmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ2aWJld3JpdGUtc2lkZWJhclwiKTtcbiAgICBpZiAoc2lkZWJhciAmJiAhc2lkZWJhci5jbGFzc0xpc3QuY29udGFpbnMoXCJvcGVuXCIpKSB7XG4gICAgICAgIHNpZGViYXIuY2xhc3NMaXN0LmFkZChcIm9wZW5cIik7XG4gICAgfVxuICAgIC8vIFNlbmQgdGhlIGFuYWx5emUgbWVzc2FnZSBkaXJlY3RseSB0byB0aGUgc2lkZWJhciBpZnJhbWVcbiAgICBjb25zdCBzaWRlYmFySWZyYW1lID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIiN2aWJld3JpdGUtc2lkZWJhciBpZnJhbWVcIik7XG4gICAgaWYgKHNpZGViYXJJZnJhbWUpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJTZW5kaW5nIEFOQUxZWkVfRE9DVU1FTlQgdG8gc2lkZWJhciBpZnJhbWVcIik7XG4gICAgICAgIChfYSA9IHNpZGViYXJJZnJhbWUuY29udGVudFdpbmRvdykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnBvc3RNZXNzYWdlKHsgdHlwZTogXCJBTkFMWVpFX0RPQ1VNRU5UXCIgfSwgXCIqXCIpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkNvdWxkIG5vdCBmaW5kIHNpZGViYXIgaWZyYW1lXCIpO1xuICAgICAgICAvLyBGYWxsYmFjayB0byBzZW5kaW5nIHZpYSBjaHJvbWUgcnVudGltZSBtZXNzYWdpbmdcbiAgICAgICAgY2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2UoeyB0eXBlOiBcIkFOQUxZWkVfRE9DVU1FTlRcIiB9KTtcbiAgICB9XG59XG4vLyBGdW5jdGlvbiB0byBhZGQgZmVlZGJhY2sgdG8gc2VsZWN0ZWQgdGV4dFxuZnVuY3Rpb24gYWRkRmVlZGJhY2soKSB7XG4gICAgLy8gR2V0IHRoZSBzZWxlY3RlZCB0ZXh0XG4gICAgY29uc3Qgc2VsZWN0ZWRUZXh0ID0gR29vZ2xlRG9jc0FQSS5nZXRTZWxlY3RlZFRleHQoKTtcbiAgICBpZiAoIXNlbGVjdGVkVGV4dCkge1xuICAgICAgICBhbGVydChcIlBsZWFzZSBzZWxlY3Qgc29tZSB0ZXh0IHRvIGdpdmUgZmVlZGJhY2sgb24uXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIE9wZW4gdGhlIHNpZGViYXJcbiAgICBjb25zdCBzaWRlYmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ2aWJld3JpdGUtc2lkZWJhclwiKTtcbiAgICBpZiAoc2lkZWJhciAmJiAhc2lkZWJhci5jbGFzc0xpc3QuY29udGFpbnMoXCJvcGVuXCIpKSB7XG4gICAgICAgIHNpZGViYXIuY2xhc3NMaXN0LmFkZChcIm9wZW5cIik7XG4gICAgfVxuICAgIC8vIFNlbmQgYSBtZXNzYWdlIHRvIHRoZSBzaWRlYmFyIHRvIGFuYWx5emUgdGhlIHNlbGVjdGVkIHRleHRcbiAgICBjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZSh7XG4gICAgICAgIHR5cGU6IFwiQ0hBVF9SRVFVRVNUXCIsXG4gICAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBQbGVhc2UgcmV2aWV3IGFuZCBpbXByb3ZlIHRoZSBmb2xsb3dpbmcgdGV4dDogXCIke3NlbGVjdGVkVGV4dH1cImAsXG4gICAgICAgICAgICBzZWxlY3RlZFRleHQsXG4gICAgICAgIH0sXG4gICAgfSk7XG59XG4vLyBTZXQgdXAgbWVzc2FnZSBoYW5kbGVyc1xuZnVuY3Rpb24gc2V0dXBNZXNzYWdlSGFuZGxlcnMoKSB7XG4gICAgY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmFkZExpc3RlbmVyKChtZXNzYWdlLCBzZW5kZXIsIHNlbmRSZXNwb25zZSkgPT4ge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ29udGVudCBzY3JpcHQgcmVjZWl2ZWQgbWVzc2FnZTpcIiwgbWVzc2FnZSk7XG4gICAgICAgIHN3aXRjaCAobWVzc2FnZS50eXBlKSB7XG4gICAgICAgICAgICBjYXNlIFwiVE9HR0xFX1NJREVCQVJcIjpcbiAgICAgICAgICAgICAgICB0b2dnbGVTaWRlYmFyKCk7XG4gICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKHsgc3VjY2VzczogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJSRUxPQURfU0VUVElOR1NcIjpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlJlbG9hZGluZyBzZXR0aW5ncyBpbiBjb250ZW50IHNjcmlwdFwiKTtcbiAgICAgICAgICAgICAgICAvLyBGb3J3YXJkIHRoZSBtZXNzYWdlIHRvIHRoZSBzaWRlYmFyIGlmcmFtZVxuICAgICAgICAgICAgICAgIGNvbnN0IHNpZGViYXJJZnJhbWUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3ZpYmV3cml0ZS1zaWRlYmFyIGlmcmFtZVwiKTtcbiAgICAgICAgICAgICAgICBpZiAoc2lkZWJhcklmcmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAoX2EgPSBzaWRlYmFySWZyYW1lLmNvbnRlbnRXaW5kb3cpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wb3N0TWVzc2FnZSh7IHR5cGU6IFwiUkVMT0FEX1NFVFRJTkdTXCIgfSwgXCIqXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UoeyBzdWNjZXNzOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcIkdFVF9TRUxFQ1RFRF9URVhUXCI6XG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRUZXh0ID0gR29vZ2xlRG9jc0FQSS5nZXRTZWxlY3RlZFRleHQoKTtcbiAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UoeyBzdWNjZXNzOiB0cnVlLCBkYXRhOiBzZWxlY3RlZFRleHQgfSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiR0VUX0RPQ1VNRU5UX0NPTlRFTlRcIjpcbiAgICAgICAgICAgICAgICBjb25zdCBkb2N1bWVudENvbnRlbnQgPSBHb29nbGVEb2NzQVBJLmdldERvY3VtZW50Q29udGVudCgpO1xuICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IGRvY3VtZW50Q29udGVudCB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJBRERfQ09NTUVOVFwiOlxuICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLnBheWxvYWQgJiYgbWVzc2FnZS5wYXlsb2FkLmNvbW1lbnRUZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBHb29nbGVEb2NzQVBJLmFkZENvbW1lbnQobWVzc2FnZS5wYXlsb2FkLmNvbW1lbnRUZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKHsgc3VjY2VzcyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBcIk5vIGNvbW1lbnQgdGV4dCBwcm92aWRlZFwiLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogXCJVbmtub3duIG1lc3NhZ2UgdHlwZVwiLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlOyAvLyBJbmRpY2F0ZXMgd2UnbGwgcmVzcG9uZCBhc3luY2hyb25vdXNseVxuICAgIH0pO1xufVxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIHdhaXQgZm9yIGFuIGVsZW1lbnQgdG8gYmUgcHJlc2VudCBpbiB0aGUgRE9NXG5mdW5jdGlvbiB3YWl0Rm9yRWxlbWVudChzZWxlY3RvciwgdGltZW91dCA9IDEwMDAwKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgZnVuY3Rpb24gY2hlY2tFbGVtZW50KCkge1xuICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xuICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKGVsZW1lbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSA+IHRpbWVvdXQpIHtcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBUaW1lb3V0IHdhaXRpbmcgZm9yIGVsZW1lbnQ6ICR7c2VsZWN0b3J9YCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChjaGVja0VsZW1lbnQsIDEwMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2hlY2tFbGVtZW50KCk7XG4gICAgfSk7XG59XG4iXSwibmFtZXMiOlsiR29vZ2xlRG9jc0FQSSIsInN0YXJ0RGVidWdMb2dnaW5nIiwidGhpcyIsImRlYnVnSW50ZXJ2YWwiLCJjb25zb2xlIiwibG9nIiwid2luZG93Iiwic2V0SW50ZXJ2YWwiLCJfYSIsIm5vdyIsIkRhdGUiLCJsYXN0RGVidWdUaW1lIiwiaXNJbkRvY3MiLCJpc0luR29vZ2xlRG9jcyIsInBhcmFncmFwaHMiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJsZW5ndGgiLCJmaXJzdFBhcmEiLCJ0ZXh0Q29udGVudCIsInN1YnN0cmluZyIsInN0b3BEZWJ1Z0xvZ2dpbmciLCJjbGVhckludGVydmFsIiwibG9jYXRpb24iLCJob3N0bmFtZSIsInF1ZXJ5U2VsZWN0b3IiLCJlcnJvciIsImdldERvY3VtZW50Q29udGVudCIsIm1heFJldHJpZXMiLCJhbHRlcm5hdGl2ZXMiLCJzZWxlY3RvciIsImVsZW1lbnRzIiwiY29udGVudCIsIkFycmF5IiwiZnJvbSIsIm1hcCIsImVsZW1lbnQiLCJmaWx0ZXIiLCJCb29sZWFuIiwiam9pbiIsIlByb21pc2UiLCJyZXNvbHZlIiwic2V0VGltZW91dCIsImRvY3VtZW50Q29udGVudCIsIndhcm4iLCJnZXRTZWxlY3RlZFRleHQiLCJnZXRTZWxlY3Rpb24iLCJzZWxlY3Rpb24iLCJ0b1N0cmluZyIsImFkZENvbW1lbnQiLCJjb21tZW50VGV4dCIsImNvbW1lbnRCdXR0b24iLCJjbGljayIsIl9iIiwiY29tbWVudEJveCIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsIkhUTUxUZXh0QXJlYUVsZW1lbnQiLCJwcm90b3R5cGUiLCJzZXQiLCJjYWxsIiwiZGlzcGF0Y2hFdmVudCIsIkV2ZW50IiwiYnViYmxlcyIsImNvbW1lbnRTdWJtaXRCdXR0b24iLCJmaW5kIiwiYnV0dG9uIiwiaXNHb29nbGVEb2NzVXJsIiwidXJsIiwic3RhcnRzV2l0aCIsImdldERvY3VtZW50VGl0bGUiLCJ0aXRsZUVsZW1lbnQiLCJ0b2dnbGVTaWRlYmFyIiwic2lkZWJhciIsImdldEVsZW1lbnRCeUlkIiwiY2xhc3NMaXN0IiwidG9nZ2xlIiwiYW5hbHl6ZURvY3VtZW50IiwiY29udGFpbnMiLCJhZGQiLCJzaWRlYmFySWZyYW1lIiwiY29udGVudFdpbmRvdyIsInBvc3RNZXNzYWdlIiwidHlwZSIsImNocm9tZSIsInJ1bnRpbWUiLCJzZW5kTWVzc2FnZSIsImFkZEZlZWRiYWNrIiwic2VsZWN0ZWRUZXh0IiwiYWxlcnQiLCJwYXlsb2FkIiwibWVzc2FnZSIsInZpYmVXcml0ZUluamVjdGVkIiwiYWRkRXZlbnRMaXN0ZW5lciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiZ2VuZXJhdG9yIiwidGltZW91dCIsInJlamVjdCIsInN0YXJ0VGltZSIsImNoZWNrRWxlbWVudCIsIkVycm9yIiwid2FpdEZvckVsZW1lbnQiLCJjaGVja0NvdW50IiwiY2hlY2tJbnRlcnZhbCIsImVyciIsInN0YXJ0RG9jdW1lbnRNb25pdG9yaW5nIiwic2lkZWJhckNvbnRhaW5lciIsImNyZWF0ZUVsZW1lbnQiLCJjbGFzc05hbWUiLCJpZCIsImJvZHkiLCJhcHBlbmRDaGlsZCIsInN0eWxlIiwid2lkdGgiLCJoZWlnaHQiLCJib3JkZXIiLCJzcmMiLCJnZXRVUkwiLCJ0b29sYmFyQ29udGFpbmVyIiwidmliZVdyaXRlVG9vbGJhciIsImRpc3BsYXkiLCJhbGlnbkl0ZW1zIiwidG9nZ2xlU2lkZWJhckJ1dHRvbiIsImJhY2tncm91bmRDb2xvciIsImNvbG9yIiwicGFkZGluZyIsImJvcmRlclJhZGl1cyIsImN1cnNvciIsIm1hcmdpblJpZ2h0IiwiYW5hbHl6ZUJ1dHRvbiIsImZlZWRiYWNrQnV0dG9uIiwiaW5zZXJ0QmVmb3JlIiwiZmlyc3RDaGlsZCIsImFkZFZpYmVXcml0ZVVJIiwib25NZXNzYWdlIiwiYWRkTGlzdGVuZXIiLCJzZW5kZXIiLCJzZW5kUmVzcG9uc2UiLCJzdWNjZXNzIiwiZGF0YSIsIlAiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSJdLCJzb3VyY2VSb290IjoiIn0=