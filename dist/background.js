(()=>{"use strict";var e=function(e,o,t,r){return new(t||(t=Promise))((function(n,s){function c(e){try{l(r.next(e))}catch(e){s(e)}}function a(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var o;e.done?n(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(c,a)}l((r=r.apply(e,o||[])).next())}))};function o(o){return e(this,void 0,void 0,(function*(){var e;try{console.log("Testing connection to Ollama server at",o);const t=yield fetch(`${o}/api/tags`);if(t.ok){const o=yield t.json();return console.log("Ollama connection successful. Available models:",null===(e=o.models)||void 0===e?void 0:e.map((e=>e.name)).join(", ")),!0}return console.warn(`Ollama server returned status ${t.status}: ${t.statusText}`),!1}catch(e){return console.warn("Could not connect to Ollama server:",e),!1}}))}chrome.runtime.onInstalled.addListener((e=>{console.log("VibeWrite installed:",e),chrome.storage.sync.set({useDarkMode:!1,autoSuggest:!1,aiProvider:"openai",aiModel:"gpt-4",ollamaBaseUrl:"http://localhost:11434"}).then((()=>{console.log("Default settings initialized"),o("http://localhost:11434")})).catch((e=>{console.error("Error initializing settings:",e)}))})),chrome.runtime.onMessage.addListener(((t,r,n)=>{var s,c,a,l;switch(console.log("Background received message:",t,"from:",r),t.type){case"CHECK_OLLAMA_CONNECTION":return console.log("Checking Ollama connection"),o((null===(s=t.data)||void 0===s?void 0:s.baseUrl)||"http://localhost:11434").then((e=>{console.log("Ollama connection result:",e),n({success:!0,isConnected:e})})).catch((e=>{console.error("Error checking Ollama connection:",e),n({success:!1,isConnected:!1,error:e.message})})),!0;case"GET_OLLAMA_MODELS":{console.log("Getting available Ollama models");const e=(null===(c=t.data)||void 0===c?void 0:c.baseUrl)||"http://localhost:11434";return fetch(`${e}/api/tags`).then((e=>{if(!e.ok)throw new Error(`Ollama server returned ${e.status}: ${e.statusText}`);return e.json()})).then((e=>{console.log("Available Ollama models:",e),n({success:!0,models:e.models||[]})})).catch((e=>{console.error("Error getting Ollama models:",e),n({success:!1,error:e.message})})),!0}case"GET_DOCUMENT_CONTENT_API":{console.log("Background: received GET_DOCUMENT_CONTENT_API for doc",null===(a=t.data)||void 0===a?void 0:a.docId);const o=null===(l=t.data)||void 0===l?void 0:l.docId;return chrome.identity.getAuthToken({interactive:!0},(function(t){return e(this,void 0,void 0,(function*(){if(chrome.runtime.lastError)return console.error("Error getting auth token:",chrome.runtime.lastError),void n({success:!1,error:chrome.runtime.lastError.message});try{const e=yield fetch(`https://docs.googleapis.com/v1/documents/${o}`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!e.ok)throw new Error(`Google Docs API returned ${e.status}: ${e.statusText}`);const r=yield e.json();console.log("API response received, processing document content");let s="";if(r.body&&r.body.content)for(const e of r.body.content)if(e.paragraph)for(const o of e.paragraph.elements||[])o.textRun&&o.textRun.content&&(s+=o.textRun.content);console.log(`Extracted ${s.length} characters from document`),n({success:!0,data:{content:s}})}catch(e){console.error("Error fetching document via API:",e);const o=e instanceof Error?e.message:String(e);n({success:!1,error:o})}}))})),!0}case"GET_DOCUMENT_CONTENT_RELAY":return console.log("Background script relaying document content request to active tab"),r.tab&&r.tab.id?chrome.tabs.sendMessage(r.tab.id,{type:"GET_DOCUMENT_CONTENT_RELAY"},(e=>{console.log("Relay response received:",e),n(e)})):chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e.length>0&&e[0].id?chrome.tabs.sendMessage(e[0].id,{type:"GET_DOCUMENT_CONTENT_RELAY"},(e=>{console.log("Relay response from query:",e),n(e)})):n({success:!1,error:"Could not find active tab for relay"})})),!0;case"TOGGLE_SIDEBAR":return console.log("Background handling TOGGLE_SIDEBAR request"),chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e.length>0&&e[0].id?(console.log("Sending TOGGLE_SIDEBAR message to content script in tab:",e[0].id),chrome.tabs.sendMessage(e[0].id,{type:"TOGGLE_SIDEBAR"},(e=>{console.log("Toggle sidebar response:",e),n(e||{success:!0})}))):(console.error("No active tab found"),n({success:!1,error:"Could not find active tab"}))})),!0;case"OLLAMA_API_REQUEST":{console.log("Processing Ollama API request in background");const{baseUrl:e,model:o,prompt:r}=t.data||{};return fetch(`${e}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:o,prompt:r,stream:!1,options:{temperature:.7,num_predict:500}})}).then((e=>{if(!e.ok)throw new Error(`Ollama server returned ${e.status}: ${e.statusText}`);return e.json()})).then((e=>{console.log("Ollama API response received:",e),n({success:!0,data:e})})).catch((e=>{console.error("Error in Ollama API call:",e),n({success:!1,error:e.message})})),!0}case"GET_API_KEY":return chrome.storage.sync.get("openaiApiKey").then((e=>{n({success:!0,data:e.openaiApiKey||""})})).catch((e=>{console.error("Error getting API key:",e),n({success:!1,error:"Failed to retrieve API key"})})),!0;default:return console.log("Unhandled message type:",t.type),n({success:!1,error:`Unhandled message type: ${t.type}`}),!1}}))})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LElBQy9CLElBRURsRCxPQUFPZCxJQUNSZixRQUFRZSxNQUFNLHlCQUEwQkEsR0FDeENrQixFQUFhLENBQ1RNLFNBQVMsRUFDVHhCLE1BQU8sOEJBQ1QsS0FFQyxFQUVYLFFBTUksT0FMQWYsUUFBUUMsSUFBSSwwQkFBMkI4QixFQUFRTSxNQUMvQ0osRUFBYSxDQUNUTSxTQUFTLEVBQ1R4QixNQUFPLDJCQUEyQmdCLEVBQVFNLFVBRXZDLEVBRWYsRyIsInNvdXJjZXMiOlsid2VicGFjazovL3ZpYmV3cml0ZS8uL3NyYy9iYWNrZ3JvdW5kL2luZGV4LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQmFja2dyb3VuZCBTY3JpcHQgZm9yIFZpYmVXcml0ZSBleHRlbnNpb25cbiAqXG4gKiBUaGlzIHNjcmlwdCBydW5zIGluIHRoZSBiYWNrZ3JvdW5kIGFuZCBoYW5kbGVzIGNvbW11bmljYXRpb24gYmV0d2VlblxuICogcG9wdXAsIGNvbnRlbnQgc2NyaXB0cywgYW5kIHRoZSBzZXJ2ZXIuXG4gKi9cbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuLy8gTGlzdGVuIGZvciBpbnN0YWxsYXRpb24gZXZlbnRzXG5jaHJvbWUucnVudGltZS5vbkluc3RhbGxlZC5hZGRMaXN0ZW5lcigoZGV0YWlscykgPT4ge1xuICAgIGNvbnNvbGUubG9nKFwiVmliZVdyaXRlIGluc3RhbGxlZDpcIiwgZGV0YWlscyk7IC8vIFNldCBkZWZhdWx0IHNldHRpbmdzXG4gICAgY2hyb21lLnN0b3JhZ2Uuc3luY1xuICAgICAgICAuc2V0KHtcbiAgICAgICAgdXNlRGFya01vZGU6IGZhbHNlLFxuICAgICAgICBhdXRvU3VnZ2VzdDogZmFsc2UsXG4gICAgICAgIGFpUHJvdmlkZXI6IFwib3BlbmFpXCIsXG4gICAgICAgIGFpTW9kZWw6IFwiZ3B0LTRcIixcbiAgICAgICAgb2xsYW1hQmFzZVVybDogXCJodHRwOi8vbG9jYWxob3N0OjExNDM0XCIsXG4gICAgfSlcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhcIkRlZmF1bHQgc2V0dGluZ3MgaW5pdGlhbGl6ZWRcIik7XG4gICAgICAgIC8vIFRlc3QgT2xsYW1hIGNvbm5lY3Rpdml0eSBvbiBpbnN0YWxsXG4gICAgICAgIGNoZWNrT2xsYW1hQ29ubmVjdGlvbihcImh0dHA6Ly9sb2NhbGhvc3Q6MTE0MzRcIik7XG4gICAgfSlcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgaW5pdGlhbGl6aW5nIHNldHRpbmdzOlwiLCBlcnJvcik7XG4gICAgfSk7XG59KTtcbi8vIEhlbHBlciBmdW5jdGlvbiB0byBjaGVjayBpZiBPbGxhbWEgc2VydmVyIGlzIGFjY2Vzc2libGVcbmZ1bmN0aW9uIGNoZWNrT2xsYW1hQ29ubmVjdGlvbihiYXNlVXJsKSB7XG4gICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUZXN0aW5nIGNvbm5lY3Rpb24gdG8gT2xsYW1hIHNlcnZlciBhdFwiLCBiYXNlVXJsKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0geWllbGQgZmV0Y2goYCR7YmFzZVVybH0vYXBpL3RhZ3NgKTtcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5vaykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB5aWVsZCByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJPbGxhbWEgY29ubmVjdGlvbiBzdWNjZXNzZnVsLiBBdmFpbGFibGUgbW9kZWxzOlwiLCAoX2EgPSBkYXRhLm1vZGVscykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLm1hcCgobSkgPT4gbS5uYW1lKS5qb2luKFwiLCBcIikpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBPbGxhbWEgc2VydmVyIHJldHVybmVkIHN0YXR1cyAke3Jlc3BvbnNlLnN0YXR1c306ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXCJDb3VsZCBub3QgY29ubmVjdCB0byBPbGxhbWEgc2VydmVyOlwiLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cbi8vIEhhbmRsZSBtZXNzYWdlcyBmcm9tIGNvbnRlbnQgc2NyaXB0cyBhbmQgcG9wdXBcbmNocm9tZS5ydW50aW1lLm9uTWVzc2FnZS5hZGRMaXN0ZW5lcigobWVzc2FnZSwgc2VuZGVyLCBzZW5kUmVzcG9uc2UpID0+IHtcbiAgICB2YXIgX2EsIF9iLCBfYywgX2Q7XG4gICAgY29uc29sZS5sb2coXCJCYWNrZ3JvdW5kIHJlY2VpdmVkIG1lc3NhZ2U6XCIsIG1lc3NhZ2UsIFwiZnJvbTpcIiwgc2VuZGVyKTtcbiAgICAvLyBIYW5kbGUgZGlmZmVyZW50IG1lc3NhZ2UgdHlwZXNcbiAgICBzd2l0Y2ggKG1lc3NhZ2UudHlwZSkge1xuICAgICAgICBjYXNlIFwiQ0hFQ0tfT0xMQU1BX0NPTk5FQ1RJT05cIjoge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJDaGVja2luZyBPbGxhbWEgY29ubmVjdGlvblwiKTtcbiAgICAgICAgICAgIGNvbnN0IHVybCA9ICgoX2EgPSBtZXNzYWdlLmRhdGEpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5iYXNlVXJsKSB8fCBcImh0dHA6Ly9sb2NhbGhvc3Q6MTE0MzRcIjtcbiAgICAgICAgICAgIGNoZWNrT2xsYW1hQ29ubmVjdGlvbih1cmwpXG4gICAgICAgICAgICAgICAgLnRoZW4oKGlzQ29ubmVjdGVkKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJPbGxhbWEgY29ubmVjdGlvbiByZXN1bHQ6XCIsIGlzQ29ubmVjdGVkKTtcbiAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2Uoe1xuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBpc0Nvbm5lY3RlZDogaXNDb25uZWN0ZWQsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgY2hlY2tpbmcgT2xsYW1hIGNvbm5lY3Rpb246XCIsIGVycm9yKTtcbiAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2Uoe1xuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgaXNDb25uZWN0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIEltcG9ydGFudDogaW5kaWNhdGVzIHdlJ2xsIHJlc3BvbmQgYXN5bmNocm9ub3VzbHlcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFwiR0VUX09MTEFNQV9NT0RFTFNcIjoge1xuICAgICAgICAgICAgLy8gR2V0IGF2YWlsYWJsZSBtb2RlbHMgZnJvbSBPbGxhbWFcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiR2V0dGluZyBhdmFpbGFibGUgT2xsYW1hIG1vZGVsc1wiKTtcbiAgICAgICAgICAgIGNvbnN0IG1vZGVsVXJsID0gKChfYiA9IG1lc3NhZ2UuZGF0YSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmJhc2VVcmwpIHx8IFwiaHR0cDovL2xvY2FsaG9zdDoxMTQzNFwiO1xuICAgICAgICAgICAgZmV0Y2goYCR7bW9kZWxVcmx9L2FwaS90YWdzYClcbiAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgT2xsYW1hIHNlcnZlciByZXR1cm5lZCAke3Jlc3BvbnNlLnN0YXR1c306ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkF2YWlsYWJsZSBPbGxhbWEgbW9kZWxzOlwiLCBkYXRhKTtcbiAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2Uoe1xuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBtb2RlbHM6IGRhdGEubW9kZWxzIHx8IFtdLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGdldHRpbmcgT2xsYW1hIG1vZGVsczpcIiwgZXJyb3IpO1xuICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIEltcG9ydGFudDogaW5kaWNhdGVzIHdlJ2xsIHJlc3BvbmQgYXN5bmNocm9ub3VzbHlcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFwiR0VUX0RPQ1VNRU5UX0NPTlRFTlRfQVBJXCI6IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQmFja2dyb3VuZDogcmVjZWl2ZWQgR0VUX0RPQ1VNRU5UX0NPTlRFTlRfQVBJIGZvciBkb2NcIiwgKF9jID0gbWVzc2FnZS5kYXRhKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZG9jSWQpO1xuICAgICAgICAgICAgY29uc3QgZG9jSWQgPSAoX2QgPSBtZXNzYWdlLmRhdGEpID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC5kb2NJZDtcbiAgICAgICAgICAgIC8vIEV4Y2hhbmdlIE9BdXRoIHRva2VuIGFuZCBjYWxsIEdvb2dsZSBEb2NzIFJFU1QgQVBJXG4gICAgICAgICAgICBjaHJvbWUuaWRlbnRpdHkuZ2V0QXV0aFRva2VuKHsgaW50ZXJhY3RpdmU6IHRydWUgfSwgZnVuY3Rpb24gKHRva2VuKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNocm9tZS5ydW50aW1lLmxhc3RFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGdldHRpbmcgYXV0aCB0b2tlbjpcIiwgY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGNocm9tZS5ydW50aW1lLmxhc3RFcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1ha2UgYXV0aGVudGljYXRlZCByZXF1ZXN0IHRvIEdvb2dsZSBEb2NzIEFQSVxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcCA9IHlpZWxkIGZldGNoKGBodHRwczovL2RvY3MuZ29vZ2xlYXBpcy5jb20vdjEvZG9jdW1lbnRzLyR7ZG9jSWR9YCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzcC5vaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgR29vZ2xlIERvY3MgQVBJIHJldHVybmVkICR7cmVzcC5zdGF0dXN9OiAke3Jlc3Auc3RhdHVzVGV4dH1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGpzb24gPSB5aWVsZCByZXNwLmpzb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQVBJIHJlc3BvbnNlIHJlY2VpdmVkLCBwcm9jZXNzaW5nIGRvY3VtZW50IGNvbnRlbnRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBGbGF0dGVuIGJvZHkgY29udGVudCB0byB0ZXh0XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgY29udGVudCA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoanNvbi5ib2R5ICYmIGpzb24uYm9keS5jb250ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBzdHJ1Y3R1cmFsRWxlbWVudCBvZiBqc29uLmJvZHkuY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RydWN0dXJhbEVsZW1lbnQucGFyYWdyYXBoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGVsZW0gb2Ygc3RydWN0dXJhbEVsZW1lbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucGFyYWdyYXBoLmVsZW1lbnRzIHx8IFtdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW0udGV4dFJ1biAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtLnRleHRSdW4uY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50ICs9IGVsZW0udGV4dFJ1bi5jb250ZW50O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBFeHRyYWN0ZWQgJHtjb250ZW50Lmxlbmd0aH0gY2hhcmFjdGVycyBmcm9tIGRvY3VtZW50YCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UoeyBzdWNjZXNzOiB0cnVlLCBkYXRhOiB7IGNvbnRlbnQgfSB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgZmV0Y2hpbmcgZG9jdW1lbnQgdmlhIEFQSTpcIiwgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLm1lc3NhZ2UgOiBTdHJpbmcoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgXCJHRVRfRE9DVU1FTlRfQ09OVEVOVF9SRUxBWVwiOiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkJhY2tncm91bmQgc2NyaXB0IHJlbGF5aW5nIGRvY3VtZW50IGNvbnRlbnQgcmVxdWVzdCB0byBhY3RpdmUgdGFiXCIpO1xuICAgICAgICAgICAgaWYgKHNlbmRlci50YWIgJiYgc2VuZGVyLnRhYi5pZCkge1xuICAgICAgICAgICAgICAgIC8vIEZvcndhcmQgdGhlIHJlcXVlc3QgdG8gY29udGVudCBzY3JpcHQgaW4gdGhlIGFjdGl2ZSB0YWJcbiAgICAgICAgICAgICAgICBjaHJvbWUudGFicy5zZW5kTWVzc2FnZShzZW5kZXIudGFiLmlkLCB7IHR5cGU6IFwiR0VUX0RPQ1VNRU5UX0NPTlRFTlRfUkVMQVlcIiB9LCAocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJSZWxheSByZXNwb25zZSByZWNlaXZlZDpcIiwgcmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2UocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gVHJ5IHRvIGZpbmQgYWN0aXZlIHRhYiBpZiBzZW5kZXIgdGFiIG5vdCBhdmFpbGFibGVcbiAgICAgICAgICAgICAgICBjaHJvbWUudGFicy5xdWVyeSh7IGFjdGl2ZTogdHJ1ZSwgY3VycmVudFdpbmRvdzogdHJ1ZSB9LCAodGFicykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGFicy5sZW5ndGggPiAwICYmIHRhYnNbMF0uaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS50YWJzLnNlbmRNZXNzYWdlKHRhYnNbMF0uaWQsIHsgdHlwZTogXCJHRVRfRE9DVU1FTlRfQ09OVEVOVF9SRUxBWVwiIH0sIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUmVsYXkgcmVzcG9uc2UgZnJvbSBxdWVyeTpcIiwgcmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZShyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IFwiQ291bGQgbm90IGZpbmQgYWN0aXZlIHRhYiBmb3IgcmVsYXlcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFwiVE9HR0xFX1NJREVCQVJcIjoge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJCYWNrZ3JvdW5kIGhhbmRsaW5nIFRPR0dMRV9TSURFQkFSIHJlcXVlc3RcIik7XG4gICAgICAgICAgICAvLyBHZXQgdGhlIGFjdGl2ZSB0YWIgYW5kIHNlbmQgdGhlIHRvZ2dsZSBtZXNzYWdlIHRvIGl0XG4gICAgICAgICAgICBjaHJvbWUudGFicy5xdWVyeSh7IGFjdGl2ZTogdHJ1ZSwgY3VycmVudFdpbmRvdzogdHJ1ZSB9LCAodGFicykgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0YWJzLmxlbmd0aCA+IDAgJiYgdGFic1swXS5pZCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlNlbmRpbmcgVE9HR0xFX1NJREVCQVIgbWVzc2FnZSB0byBjb250ZW50IHNjcmlwdCBpbiB0YWI6XCIsIHRhYnNbMF0uaWQpO1xuICAgICAgICAgICAgICAgICAgICBjaHJvbWUudGFicy5zZW5kTWVzc2FnZSh0YWJzWzBdLmlkLCB7IHR5cGU6IFwiVE9HR0xFX1NJREVCQVJcIiB9LCAocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVG9nZ2xlIHNpZGViYXIgcmVzcG9uc2U6XCIsIHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZShyZXNwb25zZSB8fCB7IHN1Y2Nlc3M6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIk5vIGFjdGl2ZSB0YWIgZm91bmRcIik7XG4gICAgICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBcIkNvdWxkIG5vdCBmaW5kIGFjdGl2ZSB0YWJcIlxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgXCJPTExBTUFfQVBJX1JFUVVFU1RcIjoge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJQcm9jZXNzaW5nIE9sbGFtYSBBUEkgcmVxdWVzdCBpbiBiYWNrZ3JvdW5kXCIpO1xuICAgICAgICAgICAgLy8gRXh0cmFjdCBPbGxhbWEgQVBJIHJlcXVlc3QgZGV0YWlsc1xuICAgICAgICAgICAgY29uc3QgeyBiYXNlVXJsLCBtb2RlbCwgcHJvbXB0IH0gPSBtZXNzYWdlLmRhdGEgfHwge307XG4gICAgICAgICAgICAvLyBNYWtlIHRoZSBPbGxhbWEgQVBJIGNhbGwgZnJvbSB0aGUgYmFja2dyb3VuZCBzY3JpcHQgdG8gYXZvaWQgQ09SU1xuICAgICAgICAgICAgZmV0Y2goYCR7YmFzZVVybH0vYXBpL2dlbmVyYXRlYCwge1xuICAgICAgICAgICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgbW9kZWw6IG1vZGVsLFxuICAgICAgICAgICAgICAgICAgICBwcm9tcHQ6IHByb21wdCxcbiAgICAgICAgICAgICAgICAgICAgc3RyZWFtOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGVyYXR1cmU6IDAuNyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bV9wcmVkaWN0OiA1MDAsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPbGxhbWEgc2VydmVyIHJldHVybmVkICR7cmVzcG9uc2Uuc3RhdHVzfTogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiT2xsYW1hIEFQSSByZXNwb25zZSByZWNlaXZlZDpcIiwgZGF0YSk7XG4gICAgICAgICAgICAgICAgc2VuZFJlc3BvbnNlKHtcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogZGF0YSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBpbiBPbGxhbWEgQVBJIGNhbGw6XCIsIGVycm9yKTtcbiAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2Uoe1xuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBJbXBvcnRhbnQ6IGluZGljYXRlcyB3ZSdsbCByZXNwb25kIGFzeW5jaHJvbm91c2x5XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBcIkdFVF9BUElfS0VZXCI6IHtcbiAgICAgICAgICAgIGNocm9tZS5zdG9yYWdlLnN5bmNcbiAgICAgICAgICAgICAgICAuZ2V0KFwib3BlbmFpQXBpS2V5XCIpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIHNlbmRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHJlc3VsdC5vcGVuYWlBcGlLZXkgfHwgXCJcIixcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBnZXR0aW5nIEFQSSBrZXk6XCIsIGVycm9yKTtcbiAgICAgICAgICAgICAgICBzZW5kUmVzcG9uc2Uoe1xuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IFwiRmFpbGVkIHRvIHJldHJpZXZlIEFQSSBrZXlcIixcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIEltcG9ydGFudDogaW5kaWNhdGVzIHdlJ2xsIHJlc3BvbmQgYXN5bmNocm9ub3VzbHlcbiAgICAgICAgfVxuICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlVuaGFuZGxlZCBtZXNzYWdlIHR5cGU6XCIsIG1lc3NhZ2UudHlwZSk7XG4gICAgICAgICAgICBzZW5kUmVzcG9uc2Uoe1xuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGVycm9yOiBgVW5oYW5kbGVkIG1lc3NhZ2UgdHlwZTogJHttZXNzYWdlLnR5cGV9YCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxufSk7XG5leHBvcnQge307XG4iXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImNoZWNrT2xsYW1hQ29ubmVjdGlvbiIsImJhc2VVcmwiLCJ0aGlzIiwiX2EiLCJjb25zb2xlIiwibG9nIiwicmVzcG9uc2UiLCJmZXRjaCIsIm9rIiwiZGF0YSIsImpzb24iLCJtb2RlbHMiLCJtYXAiLCJtIiwibmFtZSIsImpvaW4iLCJ3YXJuIiwic3RhdHVzIiwic3RhdHVzVGV4dCIsImVycm9yIiwiY2hyb21lIiwicnVudGltZSIsIm9uSW5zdGFsbGVkIiwiYWRkTGlzdGVuZXIiLCJkZXRhaWxzIiwic3RvcmFnZSIsInN5bmMiLCJzZXQiLCJ1c2VEYXJrTW9kZSIsImF1dG9TdWdnZXN0IiwiYWlQcm92aWRlciIsImFpTW9kZWwiLCJvbGxhbWFCYXNlVXJsIiwiY2F0Y2giLCJvbk1lc3NhZ2UiLCJtZXNzYWdlIiwic2VuZGVyIiwic2VuZFJlc3BvbnNlIiwiX2IiLCJfYyIsIl9kIiwidHlwZSIsImlzQ29ubmVjdGVkIiwic3VjY2VzcyIsIm1vZGVsVXJsIiwiRXJyb3IiLCJkb2NJZCIsImlkZW50aXR5IiwiZ2V0QXV0aFRva2VuIiwiaW50ZXJhY3RpdmUiLCJ0b2tlbiIsImxhc3RFcnJvciIsInJlc3AiLCJoZWFkZXJzIiwiQXV0aG9yaXphdGlvbiIsImNvbnRlbnQiLCJib2R5Iiwic3RydWN0dXJhbEVsZW1lbnQiLCJwYXJhZ3JhcGgiLCJlbGVtIiwiZWxlbWVudHMiLCJ0ZXh0UnVuIiwibGVuZ3RoIiwiZXJyIiwiZXJyb3JNZXNzYWdlIiwiU3RyaW5nIiwidGFiIiwiaWQiLCJ0YWJzIiwic2VuZE1lc3NhZ2UiLCJxdWVyeSIsImFjdGl2ZSIsImN1cnJlbnRXaW5kb3ciLCJtb2RlbCIsInByb21wdCIsIm1ldGhvZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJzdHJlYW0iLCJvcHRpb25zIiwidGVtcGVyYXR1cmUiLCJudW1fcHJlZGljdCIsImdldCIsIm9wZW5haUFwaUtleSJdLCJzb3VyY2VSb290IjoiIn0=